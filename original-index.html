<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スマートポリス 契約企業向けポータル</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#2563eb',
                        'secondary': '#64748b',
                        'danger': '#dc2626',
                        'warning': '#d97706',
                        'success': '#059669',
                        'info': '#2563eb'
                    },
                    fontFamily: {
                        'jp': ['Hiragino Kaku Gothic ProN', 'ヒラギノ角ゴ ProN W3', 'メイリオ', 'Meiryo', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <style>
        /* 印刷スタイル */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { font-size: 12pt; color: black; }
            .print-break { page-break-before: always; }
        }
        .print-only { display: none; }
        
        /* カスタムスタイル */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* フォーカスリング（アクセシビリティ） */
        .focus-ring:focus {
            outline: 2px solid #2563eb;
            outline-offset: 2px;
        }

        /* ====================
         * 📱 モバイル専用UI強化
         * ==================== */
        
        /* タッチ操作最適化 */
        @media (hover: none) {
            .hover-touch {
                background-color: rgba(59, 130, 246, 0.1);
                transform: scale(0.98);
                transition: all 0.1s ease;
            }
            
            button, .btn, .nav-link {
                min-height: 44px; /* Apple推奨のタッチターゲット */
                min-width: 44px;
            }
        }

        /* スマートフォン縦向き（320px〜480px） */
        @media (max-width: 480px) {
            /* ヘッダー調整 */
            header .flex {
                padding: 0.5rem 1rem;
            }
            
            header h1 {
                font-size: 1.1rem;
            }
            
            /* メインナビを下部固定 */
            .mobile-bottom-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-top: 1px solid #e5e7eb;
                z-index: 50;
                padding: 0.5rem 0;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            }
            
            .mobile-nav-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 0.25rem;
                padding: 0 0.5rem;
            }
            
            .mobile-nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 0.5rem;
                text-decoration: none;
                color: #6b7280;
                font-size: 0.75rem;
                border-radius: 0.5rem;
                transition: all 0.2s ease;
                min-height: 60px;
            }
            
            .mobile-nav-item.active {
                color: #2563eb;
                background-color: #eff6ff;
            }
            
            .mobile-nav-item i {
                font-size: 1.2rem;
                margin-bottom: 0.25rem;
            }
            
            /* メインコンテンツ下部マージン */
            main {
                padding-bottom: 80px !important;
            }
            
            /* テーブルをカード表示に変更 */
            .mobile-card-view {
                display: none;
            }
            
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* スマホでテーブルをカード表示 */
            @media (max-width: 640px) {
                .desktop-table {
                    display: none;
                }
                
                .mobile-card-view {
                    display: block;
                }
            }
            
            /* フォーム最適化 */
            input, select, textarea {
                font-size: 16px !important; /* iOS拡大防止 */
            }
            
            /* モーダルをフルスクリーン */
            .modal-mobile-full {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                margin: 0 !important;
                border-radius: 0 !important;
                max-width: none !important;
                height: 100vh !important;
            }
        }

        /* スマートフォン横向き（481px〜768px） */
        @media (min-width: 481px) and (max-width: 768px) and (orientation: landscape) {
            .landscape-optimized {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }
        }

        /* タブレット（769px〜1024px） */
        @media (min-width: 769px) and (max-width: 1024px) {
            .tablet-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1.5rem;
            }
            
            .tablet-sidebar {
                position: sticky;
                top: 1rem;
                height: fit-content;
            }
        }

        /* PWA対応 */
        .pwa-install-prompt {
            position: fixed;
            bottom: 90px;
            left: 1rem;
            right: 1rem;
            background: #1f2937;
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateY(100px);
            transition: transform 0.3s ease;
        }
        
        .pwa-install-prompt.show {
            transform: translateY(0);
        }

        /* スワイプジェスチャー対応 */
        .swipe-container {
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }
        
        .swipe-item {
            scroll-snap-align: start;
            flex-shrink: 0;
        }

        /* 通知バッジアニメーション */
        .notification-badge {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* ダークモード対応 */
        @media (prefers-color-scheme: dark) {
            .dark-mode-auto {
                background-color: #1f2937;
                color: #f9fafb;
            }
        }

        /* 高DPI対応 */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .high-dpi-icon {
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
            }
        }

        /* 縦長画面対応（iPhone X系） */
        @media screen and (max-width: 414px) and (min-height: 812px) {
            .iphone-x-safe {
                padding-bottom: env(safe-area-inset-bottom);
                padding-top: env(safe-area-inset-top);
            }
        }
    </style>
    
    <!-- 仕様タグ（先祖返り防止） -->
    <!-- spec:c/client/portal#main@v1.0 -->
</head>

<body class="bg-gray-50 font-jp min-h-screen">
    <!-- グローバルヘッダー -->
    <header class="bg-white shadow-sm border-b no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- ロゴ・タイトル -->
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <i class="fas fa-shield-alt text-primary text-2xl mr-3"></i>
                        <h1 class="text-xl font-bold text-gray-900">スマートポリス</h1>
                    </div>
                    <div class="hidden md:block text-sm text-secondary">
                        契約企業向けポータル
                    </div>
                </div>
                
                <!-- 右側：緊急連絡・通知・ユーザー情報 -->
                <div class="flex items-center space-x-6">
                    <!-- 緊急連絡先 -->
                    <div class="hidden md:flex items-center space-x-2 text-sm">
                        <i class="fas fa-phone text-danger"></i>
                        <span class="text-gray-700">緊急時:</span>
                        <span class="font-bold text-danger">24時間 0120-999-119</span>
                    </div>
                    
                    <!-- 🔔 通知システム -->
                    <div class="relative">
                        <button id="notification-toggle" class="text-gray-400 hover:text-gray-500 transition-colors focus-ring rounded relative">
                            <i class="fas fa-bell text-xl notification-bell"></i>
                            <span id="notification-count" class="absolute -top-2 -right-2 bg-danger text-white text-xs rounded-full h-5 w-5 flex items-center justify-center notification-badge">3</span>
                        </button>
                        
                        <!-- 通知ドロップダウンパネル -->
                        <div id="notification-panel" class="absolute right-0 mt-2 w-96 bg-white rounded-lg shadow-xl border z-50 hidden">
                            <!-- ヘッダー -->
                            <div class="p-4 border-b border-gray-200">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-semibold text-gray-900">
                                        <i class="fas fa-bell mr-2"></i>通知
                                    </h3>
                                    <div class="flex items-center space-x-2">
                                        <button id="mark-all-read" class="text-sm text-blue-600 hover:text-blue-800 focus-ring rounded px-2 py-1">
                                            すべて既読
                                        </button>
                                        <button id="notification-settings" class="text-gray-400 hover:text-gray-600 focus-ring rounded p-1">
                                            <i class="fas fa-cog"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 通知リスト -->
                            <div class="max-h-96 overflow-y-auto" id="notification-list">
                                <!-- JavaScript で動的に生成 -->
                            </div>
                            
                            <!-- フッター -->
                            <div class="p-3 border-t border-gray-200 bg-gray-50 rounded-b-lg">
                                <button class="text-sm text-blue-600 hover:text-blue-800 focus-ring rounded w-full text-center py-1">
                                    すべての通知を表示
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ユーザー情報 -->
                    <div class="flex items-center space-x-3">
                        <div id="user-avatar" class="bg-primary text-white rounded-full h-9 w-9 flex items-center justify-center">
                            <i class="fas fa-user text-sm"></i>
                        </div>
                        <div class="hidden md:block">
                            <div id="user-name" class="text-sm font-medium text-gray-900">田中太郎</div>
                            <div id="user-role" class="text-xs text-secondary">○○ホールディングス株式会社</div>
                        </div>
                    </div>
                    
                    <!-- モバイルメニューボタン -->
                    <button id="mobile-menu-btn" class="lg:hidden text-gray-500 hover:text-gray-700 p-2 focus-ring rounded">
                        <i class="fas fa-bars text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- ナビゲーション（固定・先祖返り不可） -->
    <nav class="bg-primary no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="hidden lg:flex space-x-8 py-3">
                <a href="/c/dashboard" class="nav-link text-white border-b-2 border-white px-2 pb-1 text-sm font-medium whitespace-nowrap transition-colors focus-ring rounded" data-page="dashboard">
                    <i class="fas fa-home mr-2"></i>ホーム
                </a>
                <a href="/c/announcements" class="nav-link text-blue-100 hover:text-white px-2 pb-1 text-sm font-medium whitespace-nowrap transition-colors focus-ring rounded" data-page="announcements">
                    <i class="fas fa-bullhorn mr-2"></i>お知らせ
                </a>
                <a href="/c/messages" class="nav-link text-blue-100 hover:text-white px-2 pb-1 text-sm font-medium whitespace-nowrap transition-colors focus-ring rounded" data-page="messages">
                    <i class="fas fa-comments mr-2"></i>相談・連絡
                </a>
                <a href="/c/services" class="nav-link text-blue-100 hover:text-white px-2 pb-1 text-sm font-medium whitespace-nowrap transition-colors focus-ring rounded" data-page="services">
                    <i class="fas fa-concierge-bell mr-2"></i>申請（サービス）
                </a>
                <a href="/c/materials" class="nav-link text-blue-100 hover:text-white px-2 pb-1 text-sm font-medium whitespace-nowrap transition-colors focus-ring rounded" data-page="materials">
                    <i class="fas fa-folder-open mr-2"></i>資料室
                </a>
                <a href="/c/seminars" class="nav-link text-blue-100 hover:text-white px-2 pb-1 text-sm font-medium whitespace-nowrap transition-colors focus-ring rounded" data-page="seminars">
                    <i class="fas fa-calendar-alt mr-2"></i>セミナー
                </a>
                <a href="/c/billing" class="nav-link text-blue-100 hover:text-white px-2 pb-1 text-sm font-medium whitespace-nowrap transition-colors focus-ring rounded" data-page="billing">
                    <i class="fas fa-receipt mr-2"></i>請求・お支払い
                </a>
                <a href="/c/company" class="nav-link text-blue-100 hover:text-white px-2 pb-1 text-sm font-medium whitespace-nowrap transition-colors focus-ring rounded" data-page="company">
                    <i class="fas fa-building mr-2"></i>自社情報
                </a>
                <a href="/c/users" class="nav-link text-blue-100 hover:text-white px-2 pb-1 text-sm font-medium whitespace-nowrap transition-colors focus-ring rounded client-admin-only" data-page="users">
                    <i class="fas fa-users mr-2"></i>ユーザー管理
                </a>
                <a href="/c/reports" class="nav-link text-blue-100 hover:text-white px-2 pb-1 text-sm font-medium whitespace-nowrap transition-colors focus-ring rounded client-admin-only" data-page="reports">
                    <i class="fas fa-chart-line mr-2"></i>レポート・分析
                </a>
                <a href="/c/settings" class="nav-link text-blue-100 hover:text-white px-2 pb-1 text-sm font-medium whitespace-nowrap transition-colors focus-ring rounded" data-page="settings">
                    <i class="fas fa-cog mr-2"></i>設定
                </a>
            </div>
        </div>
        
        <!-- モバイルナビゲーション -->
        <div id="mobile-nav" class="lg:hidden hidden bg-blue-700">
            <div class="px-4 py-2 space-y-1">
                <a href="/c/dashboard" class="mobile-nav-link block px-3 py-2 text-white hover:bg-blue-600 rounded-md transition-colors" data-page="dashboard">
                    <i class="fas fa-home mr-3"></i>ホーム
                </a>
                <a href="/c/announcements" class="mobile-nav-link block px-3 py-2 text-blue-100 hover:bg-blue-600 rounded-md transition-colors" data-page="announcements">
                    <i class="fas fa-bullhorn mr-3"></i>お知らせ
                </a>
                <a href="/c/messages" class="mobile-nav-link block px-3 py-2 text-blue-100 hover:bg-blue-600 rounded-md transition-colors" data-page="messages">
                    <i class="fas fa-comments mr-3"></i>相談・連絡
                </a>
                <a href="/c/services" class="mobile-nav-link block px-3 py-2 text-blue-100 hover:bg-blue-600 rounded-md transition-colors" data-page="services">
                    <i class="fas fa-concierge-bell mr-3"></i>申請（サービス）
                </a>
                <a href="/c/materials" class="mobile-nav-link block px-3 py-2 text-blue-100 hover:bg-blue-600 rounded-md transition-colors" data-page="materials">
                    <i class="fas fa-folder-open mr-3"></i>資料室
                </a>
                <a href="/c/seminars" class="mobile-nav-link block px-3 py-2 text-blue-100 hover:bg-blue-600 rounded-md transition-colors" data-page="seminars">
                    <i class="fas fa-calendar-alt mr-3"></i>セミナー
                </a>
                <a href="/c/billing" class="mobile-nav-link block px-3 py-2 text-blue-100 hover:bg-blue-600 rounded-md transition-colors" data-page="billing">
                    <i class="fas fa-receipt mr-3"></i>請求・お支払い
                </a>
                <a href="/c/company" class="mobile-nav-link block px-3 py-2 text-blue-100 hover:bg-blue-600 rounded-md transition-colors" data-page="company">
                    <i class="fas fa-building mr-3"></i>自社情報
                </a>
                <a href="/c/users" class="mobile-nav-link block px-3 py-2 text-blue-100 hover:bg-blue-600 rounded-md transition-colors client-admin-only" data-page="users">
                    <i class="fas fa-users mr-3"></i>ユーザー管理
                </a>
                <a href="/c/reports" class="mobile-nav-link block px-3 py-2 text-blue-100 hover:bg-blue-600 rounded-md transition-colors client-admin-only" data-page="reports">
                    <i class="fas fa-chart-line mr-3"></i>レポート・分析
                </a>
                <a href="/c/settings" class="mobile-nav-link block px-3 py-2 text-blue-100 hover:bg-blue-600 rounded-md transition-colors" data-page="settings">
                    <i class="fas fa-cog mr-3"></i>設定
                </a>
            </div>
        </div>
    </nav>

    <!-- パンくずナビ（全ページに表示） -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 no-print">
        <nav class="flex items-center text-sm text-secondary" id="breadcrumb" aria-label="パンくずナビ">
            <a href="/c/dashboard" class="hover:text-primary focus-ring rounded">ホーム</a>
        </nav>
    </div>

    <!-- メインコンテンツエリア -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
        
        <!-- ホーム（ダッシュボード）ページ -->
        <div id="page-dashboard" class="page-content fade-in">
            <!-- spec:c/client/dashboard#main@v1.0 -->
            <div class="mb-6">
                <h2 class="text-3xl font-bold text-gray-900 mb-2">ホーム</h2>
                <p class="text-secondary">契約企業向けポータルへようこそ</p>
            </div>

            <!-- ダッシュボードカード（2列/スマホ1列） -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- 現在の対応中 -->
                <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-warning">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-exclamation-circle text-warning mr-2"></i>
                            現在の対応中
                        </h3>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">未解決の相談</span>
                            <span class="font-bold text-warning text-xl">2件</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">処理中の申請</span>
                            <span class="font-bold text-info text-xl">1件</span>
                        </div>
                        <div class="text-xs text-gray-500 pt-2 border-t">
                            最終更新: 2024年8月28日 15:30
                        </div>
                    </div>
                    <div class="mt-4">
                        <a href="/c/messages" class="inline-block bg-primary text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700 transition-colors focus-ring">
                            詳細を確認する
                        </a>
                    </div>
                </div>

                <!-- 最新のお知らせ -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-bullhorn text-info mr-2"></i>
                            最新のお知らせ
                        </h3>
                        <a href="/c/announcements" class="text-sm text-primary hover:text-blue-700 focus-ring rounded">すべて見る</a>
                    </div>
                    <div class="space-y-3">
                        <div class="border-l-3 border-danger pl-3">
                            <h4 class="font-medium text-sm text-gray-900">緊急メンテナンスのお知らせ</h4>
                            <p class="text-xs text-gray-600">2024/08/30 2:00-6:00にシステムメンテナンス...</p>
                            <span class="text-xs text-danger">重要</span>
                        </div>
                        <div class="border-l-3 border-info pl-3">
                            <h4 class="font-medium text-sm text-gray-900">新機能リリースのご案内</h4>
                            <p class="text-xs text-gray-600">資料室に検索機能が追加されました...</p>
                            <span class="text-xs text-info">お知らせ</span>
                        </div>
                        <div class="border-l-3 border-success pl-3">
                            <h4 class="font-medium text-sm text-gray-900">セミナー開催決定</h4>
                            <p class="text-xs text-gray-600">9月度のリスク管理セミナーを開催します...</p>
                            <span class="text-xs text-success">イベント</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- よく使う操作 -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-star text-warning mr-2"></i>
                        よく使う操作
                    </h3>
                    <div class="grid grid-cols-2 gap-3">
                        <a href="/c/messages/new" class="bg-primary text-white p-3 rounded-lg text-center hover:bg-blue-700 transition-colors focus-ring">
                            <i class="fas fa-edit text-lg mb-2"></i>
                            <div class="text-sm font-medium">相談を投稿する</div>
                        </a>
                        <a href="/c/services/customer-harassment" class="bg-danger text-white p-3 rounded-lg text-center hover:bg-red-700 transition-colors focus-ring">
                            <i class="fas fa-shield-alt text-lg mb-2"></i>
                            <div class="text-sm font-medium">カスハラ出動依頼</div>
                        </a>
                        <a href="/c/services/security-seal" class="bg-success text-white p-3 rounded-lg text-center hover:bg-green-700 transition-colors focus-ring">
                            <i class="fas fa-certificate text-lg mb-2"></i>
                            <div class="text-sm font-medium">セキュリティシール</div>
                        </a>
                        <a href="/c/materials" class="bg-secondary text-white p-3 rounded-lg text-center hover:bg-gray-600 transition-colors focus-ring">
                            <i class="fas fa-folder-open text-lg mb-2"></i>
                            <div class="text-sm font-medium">資料室を開く</div>
                        </a>
                    </div>
                </div>

                <!-- 次の請求予定 -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-receipt text-warning mr-2"></i>
                        次の請求予定
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">今月の月額料金</span>
                            <span class="font-bold text-lg">¥50,000</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">オプション料金</span>
                            <span class="font-bold text-lg">¥12,000</span>
                        </div>
                        <div class="border-t pt-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-900">合計（税込）</span>
                                <span class="font-bold text-xl text-primary">¥68,200</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">
                                支払期限: 2024年9月30日
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <a href="/c/billing" class="inline-block bg-primary text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700 transition-colors focus-ring">
                            請求詳細を確認
                        </a>
                    </div>
                </div>
            </div>

            <!-- セミナー開催予定 -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-calendar-alt text-info mr-2"></i>
                        セミナー開催予定
                    </h3>
                    <a href="/c/seminars" class="text-sm text-primary hover:text-blue-700 focus-ring rounded">すべて見る</a>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                        <h4 class="font-medium text-sm text-gray-900 mb-2">リスク管理基礎講座</h4>
                        <p class="text-xs text-gray-600 mb-2">
                            <i class="fas fa-calendar mr-1"></i>9月15日 14:00-17:00<br>
                            <i class="fas fa-map-marker-alt mr-1"></i>オンライン開催
                        </p>
                        <button class="w-full bg-success text-white py-2 px-3 rounded text-xs hover:bg-green-700 transition-colors focus-ring">
                            申込み
                        </button>
                    </div>
                    <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                        <h4 class="font-medium text-sm text-gray-900 mb-2">カスハラ対策実践</h4>
                        <p class="text-xs text-gray-600 mb-2">
                            <i class="fas fa-calendar mr-1"></i>9月22日 13:00-16:00<br>
                            <i class="fas fa-map-marker-alt mr-1"></i>東京会場
                        </p>
                        <button class="w-full bg-success text-white py-2 px-3 rounded text-xs hover:bg-green-700 transition-colors focus-ring">
                            申込み
                        </button>
                    </div>
                    <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                        <h4 class="font-medium text-sm text-gray-900 mb-2">情報セキュリティ対策</h4>
                        <p class="text-xs text-gray-600 mb-2">
                            <i class="fas fa-calendar mr-1"></i>10月5日 10:00-12:00<br>
                            <i class="fas fa-map-marker-alt mr-1"></i>大阪会場
                        </p>
                        <button class="w-full bg-success text-white py-2 px-3 rounded text-xs hover:bg-green-700 transition-colors focus-ring">
                            申込み
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 他のページは後で追加 -->
        <div id="page-announcements" class="page-content hidden fade-in">
            <h2 class="text-3xl font-bold text-gray-900 mb-6">お知らせ</h2>
            <p class="text-gray-600">お知らせページの内容（実装予定）</p>
        </div>

        <div id="page-messages" class="page-content hidden fade-in">
            <!-- spec:c/client/messages#main@v1.0 -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">相談・連絡</h2>
                    <p class="text-secondary">お困りごとの相談や質問、報告などにご利用ください</p>
                </div>
                <button id="new-message-btn" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors focus-ring">
                    <i class="fas fa-edit mr-2"></i>
                    新規相談
                </button>
            </div>

            <!-- フィルター・検索 -->
            <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">状態</label>
                        <select id="status-filter" class="w-full border-gray-300 rounded-md focus-ring">
                            <option value="">すべて</option>
                            <option value="received">受付中</option>
                            <option value="in-progress">対応中</option>
                            <option value="completed">完了</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">優先度</label>
                        <select id="priority-filter" class="w-full border-gray-300 rounded-md focus-ring">
                            <option value="">すべて</option>
                            <option value="high">高</option>
                            <option value="medium">中</option>
                            <option value="low">低</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">期間</label>
                        <select id="date-filter" class="w-full border-gray-300 rounded-md focus-ring">
                            <option value="">すべて</option>
                            <option value="today">今日</option>
                            <option value="week">1週間</option>
                            <option value="month">1ヶ月</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">検索</label>
                        <input type="text" id="search-messages" placeholder="件名・内容で検索" class="w-full border-gray-300 rounded-md focus-ring">
                    </div>
                </div>
            </div>

            <!-- 相談一覧テーブル -->
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">件名</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">優先度</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状態</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">担当</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">更新日</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="messages-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- サンプルデータ -->
                            <tr class="hover:bg-gray-50 cursor-pointer" onclick="showMessageDetail(1)">
                                <td class="px-6 py-4">
                                    <div class="flex items-center">
                                        <i class="fas fa-paperclip text-gray-400 mr-2"></i>
                                        <div>
                                            <div class="text-sm font-medium text-gray-900">顧客からの苦情対応について</div>
                                            <div class="text-sm text-gray-500">顧客から商品に対する苦情が寄せられました。対応方法をご相談させてください...</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                        <i class="fas fa-exclamation-circle mr-1"></i>高
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                        対応中
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-gray-900">山田コンサルタント</div>
                                    <div class="text-sm text-gray-500">リスク管理部</div>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-500">
                                    2024/08/28<br>
                                    <span class="text-xs">15:30</span>
                                </td>
                                <td class="px-6 py-4 text-sm font-medium">
                                    <button class="text-primary hover:text-blue-700 focus-ring rounded mr-3" onclick="event.stopPropagation(); showMessageDetail(1)">
                                        <i class="fas fa-eye mr-1"></i>詳細
                                    </button>
                                    <button class="text-success hover:text-green-700 focus-ring rounded" onclick="event.stopPropagation(); replyMessage(1)">
                                        <i class="fas fa-reply mr-1"></i>返信
                                    </button>
                                </td>
                            </tr>
                            <tr class="hover:bg-gray-50 cursor-pointer" onclick="showMessageDetail(2)">
                                <td class="px-6 py-4">
                                    <div class="flex items-center">
                                        <div>
                                            <div class="text-sm font-medium text-gray-900">セキュリティ研修の件</div>
                                            <div class="text-sm text-gray-500">来月予定している社員向けセキュリティ研修について、講師の手配をお願いします...</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                        <i class="fas fa-minus-circle mr-1"></i>中
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        完了
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-gray-900">佐藤マネージャー</div>
                                    <div class="text-sm text-gray-500">教育研修部</div>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-500">
                                    2024/08/27<br>
                                    <span class="text-xs">14:20</span>
                                </td>
                                <td class="px-6 py-4 text-sm font-medium">
                                    <button class="text-primary hover:text-blue-700 focus-ring rounded mr-3" onclick="event.stopPropagation(); showMessageDetail(2)">
                                        <i class="fas fa-eye mr-1"></i>詳細
                                    </button>
                                    <button class="text-secondary hover:text-gray-600 focus-ring rounded" onclick="event.stopPropagation(); archiveMessage(2)">
                                        <i class="fas fa-archive mr-1"></i>保管
                                    </button>
                                </td>
                            </tr>
                            <tr class="hover:bg-gray-50 cursor-pointer" onclick="showMessageDetail(3)">
                                <td class="px-6 py-4">
                                    <div class="flex items-center">
                                        <i class="fas fa-paperclip text-gray-400 mr-2"></i>
                                        <div>
                                            <div class="text-sm font-medium text-gray-900">月次レポートの確認</div>
                                            <div class="text-sm text-gray-500">8月分の月次レポートを添付しました。内容をご確認ください...</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                        <i class="fas fa-circle mr-1"></i>低
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        受付中
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-gray-900">未割当</div>
                                    <div class="text-sm text-gray-500">-</div>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-500">
                                    2024/08/26<br>
                                    <span class="text-xs">09:15</span>
                                </td>
                                <td class="px-6 py-4 text-sm font-medium">
                                    <button class="text-primary hover:text-blue-700 focus-ring rounded mr-3" onclick="event.stopPropagation(); showMessageDetail(3)">
                                        <i class="fas fa-eye mr-1"></i>詳細
                                    </button>
                                    <button class="text-success hover:text-green-700 focus-ring rounded" onclick="event.stopPropagation(); replyMessage(3)">
                                        <i class="fas fa-reply mr-1"></i>返信
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ページネーション -->
                <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus-ring">
                            前へ
                        </button>
                        <button class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus-ring">
                            次へ
                        </button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                <span class="font-medium">1</span>-<span class="font-medium">3</span> 件中 <span class="font-medium">3</span> 件を表示
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                                <button class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 focus-ring">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="bg-primary border-primary text-white relative inline-flex items-center px-4 py-2 border text-sm font-medium focus-ring">
                                    1
                                </button>
                                <button class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium focus-ring">
                                    2
                                </button>
                                <button class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 focus-ring">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 新規相談モーダル（初期は非表示） -->
            <div id="new-message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
                <div class="relative top-20 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <!-- モーダルヘッダー -->
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-900">新規相談</h3>
                            <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors focus-ring rounded">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <!-- 新規相談フォーム -->
                        <form id="new-message-form" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- 件名 -->
                                <div class="md:col-span-2">
                                    <label for="message-subject" class="block text-sm font-medium text-gray-700 mb-2">
                                        件名 <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" id="message-subject" name="subject" required 
                                           class="w-full border-gray-300 rounded-md focus-ring" 
                                           placeholder="相談内容の件名を入力してください">
                                </div>

                                <!-- 優先度 -->
                                <div>
                                    <label for="message-priority" class="block text-sm font-medium text-gray-700 mb-2">
                                        優先度 <span class="text-danger">*</span>
                                    </label>
                                    <select id="message-priority" name="priority" required class="w-full border-gray-300 rounded-md focus-ring">
                                        <option value="">優先度を選択</option>
                                        <option value="high">高（緊急対応必要）</option>
                                        <option value="medium">中（通常対応）</option>
                                        <option value="low">低（参考・報告）</option>
                                    </select>
                                </div>

                                <!-- カテゴリ -->
                                <div>
                                    <label for="message-category" class="block text-sm font-medium text-gray-700 mb-2">
                                        カテゴリ <span class="text-danger">*</span>
                                    </label>
                                    <select id="message-category" name="category" required class="w-full border-gray-300 rounded-md focus-ring">
                                        <option value="">カテゴリを選択</option>
                                        <option value="customer-harassment">カスハラ・迷惑行為</option>
                                        <option value="security-incident">セキュリティインシデント</option>
                                        <option value="consultation">一般的な相談</option>
                                        <option value="training-request">研修・指導依頼</option>
                                        <option value="document-request">書類・資料の依頼</option>
                                        <option value="system-issue">システム関連</option>
                                        <option value="billing-inquiry">請求・支払関連</option>
                                        <option value="other">その他</option>
                                    </select>
                                </div>
                            </div>

                            <!-- 相談内容 -->
                            <div>
                                <label for="message-content" class="block text-sm font-medium text-gray-700 mb-2">
                                    相談内容 <span class="text-danger">*</span>
                                </label>
                                <textarea id="message-content" name="content" required rows="8" 
                                          class="w-full border-gray-300 rounded-md focus-ring" 
                                          placeholder="状況の詳細、発生日時、関係者、求める対応などを具体的にご記入ください"></textarea>
                            </div>

                            <!-- 添付ファイル -->
                            <div>
                                <label for="message-files" class="block text-sm font-medium text-gray-700 mb-2">
                                    添付ファイル
                                </label>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-4"></i>
                                    <div class="text-sm text-gray-600 mb-2">
                                        ファイルをドラッグ&ドロップまたは
                                    </div>
                                    <input type="file" id="message-files" name="files" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx" 
                                           class="hidden">
                                    <button type="button" onclick="document.getElementById('message-files').click()" 
                                            class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus-ring">
                                        <i class="fas fa-paperclip mr-2"></i>
                                        ファイル選択
                                    </button>
                                    <div class="text-xs text-gray-500 mt-2">
                                        画像、PDF、Word、Excel（最大5MB、5ファイルまで）
                                    </div>
                                </div>
                                <div id="selected-files" class="mt-3 space-y-2"></div>
                            </div>

                            <!-- 連絡先情報 -->
                            <div>
                                <h4 class="text-lg font-medium text-gray-900 mb-4">連絡先情報</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="contact-name" class="block text-sm font-medium text-gray-700 mb-2">
                                            担当者名 <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" id="contact-name" name="contact_name" required 
                                               class="w-full border-gray-300 rounded-md focus-ring" 
                                               placeholder="担当者名">
                                    </div>
                                    <div>
                                        <label for="contact-phone" class="block text-sm font-medium text-gray-700 mb-2">
                                            連絡先電話番号
                                        </label>
                                        <input type="tel" id="contact-phone" name="contact_phone" 
                                               class="w-full border-gray-300 rounded-md focus-ring" 
                                               placeholder="090-1234-5678">
                                    </div>
                                </div>
                            </div>

                            <!-- 希望対応 -->
                            <div>
                                <label for="requested-action" class="block text-sm font-medium text-gray-700 mb-2">
                                    希望する対応
                                </label>
                                <textarea id="requested-action" name="requested_action" rows="3" 
                                          class="w-full border-gray-300 rounded-md focus-ring" 
                                          placeholder="具体的にどのような対応を希望されるかご記入ください"></textarea>
                            </div>

                            <!-- フォームボタン -->
                            <div class="flex justify-end space-x-4 pt-6 border-t">
                                <button type="button" id="cancel-btn" class="px-6 py-3 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors focus-ring">
                                    キャンセル
                                </button>
                                <button type="submit" class="px-6 py-3 bg-primary text-white rounded-md hover:bg-blue-700 transition-colors focus-ring">
                                    <i class="fas fa-paper-plane mr-2"></i>
                                    相談を送信
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 詳細表示モーダル（初期は非表示） -->
            <div id="message-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
                <div class="relative top-20 mx-auto p-5 border w-full max-w-5xl shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <!-- モーダルヘッダー -->
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-900">相談詳細</h3>
                            <button id="close-detail-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors focus-ring rounded">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <!-- 詳細内容（動的に更新） -->
                        <div id="message-detail-content">
                            <!-- JavaScriptで動的に内容を挿入 -->
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div id="page-services" class="page-content hidden fade-in">
            <!-- spec:c/client/services#main@v1.0 -->
            <div class="mb-6">
                <h2 class="text-3xl font-bold text-gray-900 mb-2">申請（サービス）</h2>
                <p class="text-secondary">各種セキュリティサービスをワンクリックで申込できます</p>
            </div>

            <!-- フィルター・検索 -->
            <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">カテゴリ</label>
                        <select id="service-category-filter" class="w-full border-gray-300 rounded-md focus-ring">
                            <option value="">すべてのサービス</option>
                            <option value="emergency">緊急対応</option>
                            <option value="security">セキュリティ</option>
                            <option value="training">研修・教育</option>
                            <option value="consulting">コンサルティング</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">緊急度</label>
                        <select id="service-urgency-filter" class="w-full border-gray-300 rounded-md focus-ring">
                            <option value="">すべて</option>
                            <option value="immediate">即時対応</option>
                            <option value="urgent">緊急（24時間以内）</option>
                            <option value="normal">通常（3営業日以内）</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">検索</label>
                        <input type="text" id="service-search" placeholder="サービス名で検索" class="w-full border-gray-300 rounded-md focus-ring">
                    </div>
                </div>
            </div>

            <!-- サービスカード一覧（3-4列レイアウト） -->
            <div id="services-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6">
                
                <!-- 1. カスハラ出動依頼 -->
                <div class="service-card bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow p-6 border border-gray-200" data-category="emergency" data-urgency="immediate">
                    <div class="flex items-start justify-between mb-4">
                        <div class="bg-red-100 rounded-lg p-3">
                            <i class="fas fa-shield-alt text-red-600 text-2xl"></i>
                        </div>
                        <span class="bg-red-100 text-red-800 text-xs font-medium px-2 py-1 rounded-full">緊急対応</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">カスハラ出動依頼</h3>
                    <p class="text-gray-600 text-sm mb-4">顧客からの迷惑行為・ハラスメントに対する専門スタッフの緊急派遣</p>
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-clock mr-2 text-gray-400"></i>
                            <span>30分以内に出動</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-yen-sign mr-2 text-gray-400"></i>
                            <span>基本料金: 50,000円〜</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-phone mr-2 text-gray-400"></i>
                            <span>24時間365日対応</span>
                        </div>
                    </div>
                    <button class="w-full bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 transition-colors focus-ring" 
                            onclick="openServiceApplication('customer-harassment')">
                        <i class="fas fa-paper-plane mr-2"></i>
                        緊急申込
                    </button>
                </div>

                <!-- 2. セキュリティシール -->
                <div class="service-card bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow p-6 border border-gray-200" data-category="security" data-urgency="normal">
                    <div class="flex items-start justify-between mb-4">
                        <div class="bg-blue-100 rounded-lg p-3">
                            <i class="fas fa-certificate text-blue-600 text-2xl"></i>
                        </div>
                        <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full">セキュリティ</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">セキュリティシール</h3>
                    <p class="text-gray-600 text-sm mb-4">防犯ステッカーやシールで視覚的な抑止効果を提供</p>
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-truck mr-2 text-gray-400"></i>
                            <span>3営業日以内発送</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-yen-sign mr-2 text-gray-400"></i>
                            <span>基本料金: 5,000円〜</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-palette mr-2 text-gray-400"></i>
                            <span>カスタムデザイン対応</span>
                        </div>
                    </div>
                    <button class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors focus-ring" 
                            onclick="openServiceApplication('security-seal')">
                        <i class="fas fa-shopping-cart mr-2"></i>
                        注文する
                    </button>
                </div>

                <!-- 3. セキュリティ研修 -->
                <div class="service-card bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow p-6 border border-gray-200" data-category="training" data-urgency="normal">
                    <div class="flex items-start justify-between mb-4">
                        <div class="bg-green-100 rounded-lg p-3">
                            <i class="fas fa-graduation-cap text-green-600 text-2xl"></i>
                        </div>
                        <span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded-full">研修・教育</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">セキュリティ研修</h3>
                    <p class="text-gray-600 text-sm mb-4">従業員向けの防犯・リスク管理研修プログラム</p>
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-users mr-2 text-gray-400"></i>
                            <span>1回最大50名まで</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-yen-sign mr-2 text-gray-400"></i>
                            <span>基本料金: 80,000円〜</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-clock mr-2 text-gray-400"></i>
                            <span>2-3時間のプログラム</span>
                        </div>
                    </div>
                    <button class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors focus-ring" 
                            onclick="openServiceApplication('security-training')">
                        <i class="fas fa-calendar-plus mr-2"></i>
                        研修予約
                    </button>
                </div>

                <!-- 4. リスク診断 -->
                <div class="service-card bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow p-6 border border-gray-200" data-category="consulting" data-urgency="normal">
                    <div class="flex items-start justify-between mb-4">
                        <div class="bg-purple-100 rounded-lg p-3">
                            <i class="fas fa-search text-purple-600 text-2xl"></i>
                        </div>
                        <span class="bg-purple-100 text-purple-800 text-xs font-medium px-2 py-1 rounded-full">コンサルティング</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">リスク診断</h3>
                    <p class="text-gray-600 text-sm mb-4">現状のセキュリティリスクを専門家が詳細に分析・診断</p>
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-file-alt mr-2 text-gray-400"></i>
                            <span>詳細レポート付き</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-yen-sign mr-2 text-gray-400"></i>
                            <span>基本料金: 120,000円〜</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-calendar mr-2 text-gray-400"></i>
                            <span>1週間で完了</span>
                        </div>
                    </div>
                    <button class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors focus-ring" 
                            onclick="openServiceApplication('risk-assessment')">
                        <i class="fas fa-chart-line mr-2"></i>
                        診断依頼
                    </button>
                </div>

                <!-- 5. 警備員派遣 -->
                <div class="service-card bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow p-6 border border-gray-200" data-category="emergency" data-urgency="urgent">
                    <div class="flex items-start justify-between mb-4">
                        <div class="bg-orange-100 rounded-lg p-3">
                            <i class="fas fa-user-shield text-orange-600 text-2xl"></i>
                        </div>
                        <span class="bg-orange-100 text-orange-800 text-xs font-medium px-2 py-1 rounded-full">緊急対応</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">警備員派遣</h3>
                    <p class="text-gray-600 text-sm mb-4">イベントや施設の警備を経験豊富なスタッフが担当</p>
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-clock mr-2 text-gray-400"></i>
                            <span>24時間以内配置可能</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-yen-sign mr-2 text-gray-400"></i>
                            <span>時給: 2,500円〜</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-medal mr-2 text-gray-400"></i>
                            <span>有資格者派遣</span>
                        </div>
                    </div>
                    <button class="w-full bg-orange-600 text-white py-3 px-4 rounded-lg hover:bg-orange-700 transition-colors focus-ring" 
                            onclick="openServiceApplication('security-guard')">
                        <i class="fas fa-user-plus mr-2"></i>
                        派遣依頼
                    </button>
                </div>

                <!-- 6. 防犯カメラ設置 -->
                <div class="service-card bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow p-6 border border-gray-200" data-category="security" data-urgency="normal">
                    <div class="flex items-start justify-between mb-4">
                        <div class="bg-gray-100 rounded-lg p-3">
                            <i class="fas fa-video text-gray-600 text-2xl"></i>
                        </div>
                        <span class="bg-gray-100 text-gray-800 text-xs font-medium px-2 py-1 rounded-full">セキュリティ</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">防犯カメラ設置</h3>
                    <p class="text-gray-600 text-sm mb-4">最新の防犯カメラシステムの設計・設置・保守</p>
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-tools mr-2 text-gray-400"></i>
                            <span>現地調査・設計込み</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-yen-sign mr-2 text-gray-400"></i>
                            <span>基本料金: 200,000円〜</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-headset mr-2 text-gray-400"></i>
                            <span>3年保守サポート</span>
                        </div>
                    </div>
                    <button class="w-full bg-gray-600 text-white py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors focus-ring" 
                            onclick="openServiceApplication('security-camera')">
                        <i class="fas fa-wrench mr-2"></i>
                        設置相談
                    </button>
                </div>

                <!-- 7. 法的書類作成 -->
                <div class="service-card bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow p-6 border border-gray-200" data-category="consulting" data-urgency="normal">
                    <div class="flex items-start justify-between mb-4">
                        <div class="bg-indigo-100 rounded-lg p-3">
                            <i class="fas fa-file-contract text-indigo-600 text-2xl"></i>
                        </div>
                        <span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2 py-1 rounded-full">コンサルティング</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">法的書類作成</h3>
                    <p class="text-gray-600 text-sm mb-4">内容証明や警告書など、法的効力のある書類作成サポート</p>
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-gavel mr-2 text-gray-400"></i>
                            <span>弁護士監修</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-yen-sign mr-2 text-gray-400"></i>
                            <span>基本料金: 30,000円〜</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-clock mr-2 text-gray-400"></i>
                            <span>3営業日以内作成</span>
                        </div>
                    </div>
                    <button class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors focus-ring" 
                            onclick="openServiceApplication('legal-document')">
                        <i class="fas fa-pen mr-2"></i>
                        作成依頼
                    </button>
                </div>

                <!-- 8. 緊急コンサルティング -->
                <div class="service-card bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow p-6 border border-gray-200" data-category="emergency" data-urgency="immediate">
                    <div class="flex items-start justify-between mb-4">
                        <div class="bg-yellow-100 rounded-lg p-3">
                            <i class="fas fa-phone-alt text-yellow-600 text-2xl"></i>
                        </div>
                        <span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2 py-1 rounded-full">緊急対応</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">緊急コンサルティング</h3>
                    <p class="text-gray-600 text-sm mb-4">緊急事態発生時の専門家による電話・現地での緊急相談</p>
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-phone mr-2 text-gray-400"></i>
                            <span>即座に電話対応</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-yen-sign mr-2 text-gray-400"></i>
                            <span>基本料金: 20,000円〜</span>
                        </div>
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-clock mr-2 text-gray-400"></i>
                            <span>24時間365日</span>
                        </div>
                    </div>
                    <button class="w-full bg-yellow-600 text-white py-3 px-4 rounded-lg hover:bg-yellow-700 transition-colors focus-ring" 
                            onclick="openServiceApplication('emergency-consulting')">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        緊急相談
                    </button>
                </div>
            </div>

            <!-- サービス申込モーダル（初期は非表示） -->
            <div id="service-application-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
                <div class="relative top-20 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <!-- モーダルヘッダー -->
                        <div class="flex justify-between items-center mb-6">
                            <h3 id="service-modal-title" class="text-2xl font-bold text-gray-900">サービス申込</h3>
                            <button id="close-service-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors focus-ring rounded">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <!-- ステップ表示 -->
                        <div class="mb-8">
                            <div class="flex items-center justify-center">
                                <div id="step-indicator" class="flex items-center space-x-4">
                                    <div class="step-item active flex items-center">
                                        <div class="step-circle bg-primary text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-medium">1</div>
                                        <span class="ml-2 text-sm font-medium text-primary">サービス詳細</span>
                                    </div>
                                    <div class="w-12 h-px bg-gray-300"></div>
                                    <div class="step-item flex items-center">
                                        <div class="step-circle bg-gray-300 text-gray-500 rounded-full w-8 h-8 flex items-center justify-center text-sm font-medium">2</div>
                                        <span class="ml-2 text-sm font-medium text-gray-500">詳細入力</span>
                                    </div>
                                    <div class="w-12 h-px bg-gray-300"></div>
                                    <div class="step-item flex items-center">
                                        <div class="step-circle bg-gray-300 text-gray-500 rounded-full w-8 h-8 flex items-center justify-center text-sm font-medium">3</div>
                                        <span class="ml-2 text-sm font-medium text-gray-500">確認・送信</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- フォーム内容（動的に変更） -->
                        <div id="service-form-content">
                            <!-- JavaScriptで動的に内容を挿入 -->
                        </div>

                        <!-- フォームボタン -->
                        <div class="flex justify-between items-center pt-6 border-t">
                            <button type="button" id="service-prev-btn" class="px-6 py-3 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors focus-ring hidden">
                                <i class="fas fa-chevron-left mr-2"></i>
                                戻る
                            </button>
                            <div class="flex space-x-4 ml-auto">
                                <button type="button" id="service-cancel-btn" class="px-6 py-3 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors focus-ring">
                                    キャンセル
                                </button>
                                <button type="button" id="service-next-btn" class="px-6 py-3 bg-primary text-white rounded-md hover:bg-blue-700 transition-colors focus-ring">
                                    次へ
                                    <i class="fas fa-chevron-right ml-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div id="page-materials" class="page-content hidden fade-in">
            <h2 class="text-3xl font-bold text-gray-900 mb-6">資料室</h2>
            <p class="text-gray-600">資料室ページの内容（実装予定）</p>
        </div>

        <div id="page-seminars" class="page-content hidden fade-in">
            <h2 class="text-3xl font-bold text-gray-900 mb-6">セミナー</h2>
            <p class="text-gray-600">セミナーページの内容（実装予定）</p>
        </div>

        <div id="page-billing" class="page-content hidden fade-in">
            <!-- spec:c/client/billing#main@v1.0 -->
            <div class="mb-6">
                <h2 class="text-3xl font-bold text-gray-900 mb-2">請求・お支払い</h2>
                <p class="text-secondary">請求書の確認・ダウンロードや支払い状況を管理できます</p>
            </div>

            <!-- 支払い状況サマリー -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-blue-500">
                    <div class="flex items-center">
                        <i class="fas fa-file-invoice text-blue-500 text-2xl mr-3"></i>
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">今月の請求額</h3>
                            <p class="text-2xl font-bold text-gray-900">¥485,000</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-green-500">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 text-2xl mr-3"></i>
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">支払い済み</h3>
                            <p class="text-2xl font-bold text-gray-900">¥1,250,000</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-yellow-500">
                    <div class="flex items-center">
                        <i class="fas fa-clock text-yellow-500 text-2xl mr-3"></i>
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">支払い待ち</h3>
                            <p class="text-2xl font-bold text-gray-900">¥320,000</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-red-500">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-red-500 text-2xl mr-3"></i>
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">延滞中</h3>
                            <p class="text-2xl font-bold text-gray-900">¥0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- フィルター・検索 -->
            <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">年月</label>
                        <select id="billing-period-filter" class="w-full border-gray-300 rounded-md focus-ring">
                            <option value="">すべて</option>
                            <option value="2024-08">2024年8月</option>
                            <option value="2024-07">2024年7月</option>
                            <option value="2024-06">2024年6月</option>
                            <option value="2024-05">2024年5月</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">支払い状況</label>
                        <select id="billing-status-filter" class="w-full border-gray-300 rounded-md focus-ring">
                            <option value="">すべて</option>
                            <option value="paid">支払い済み</option>
                            <option value="pending">支払い待ち</option>
                            <option value="overdue">延滞中</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">金額範囲</label>
                        <select id="billing-amount-filter" class="w-full border-gray-300 rounded-md focus-ring">
                            <option value="">すべて</option>
                            <option value="0-100000">10万円以下</option>
                            <option value="100000-500000">10-50万円</option>
                            <option value="500000+">50万円以上</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">サービス種別</label>
                        <select id="billing-service-filter" class="w-full border-gray-300 rounded-md focus-ring">
                            <option value="">すべて</option>
                            <option value="monthly">月額料金</option>
                            <option value="emergency">緊急対応</option>
                            <option value="training">研修・コンサル</option>
                            <option value="equipment">機器・設備</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">検索</label>
                        <input type="text" id="billing-search" placeholder="請求書番号・摘要で検索" class="w-full border-gray-300 rounded-md focus-ring">
                    </div>
                </div>
                
                <!-- エクスポートボタン -->
                <div class="mt-4 flex justify-end space-x-3">
                    <button class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors focus-ring">
                        <i class="fas fa-download mr-2"></i>
                        CSV出力
                    </button>
                    <button class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors focus-ring">
                        <i class="fas fa-file-pdf mr-2"></i>
                        PDF一括出力
                    </button>
                </div>
            </div>

            <!-- 請求書一覧テーブル -->
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">請求書一覧</h3>
                </div>
                
                <!-- デスクトップ用テーブル表示 -->
                <div class="overflow-x-auto desktop-table">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">請求書番号</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">請求日</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">支払期限</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">サービス</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金額</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状況</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="billing-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- サンプルデータ -->
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <i class="fas fa-file-invoice text-blue-500 mr-3"></i>
                                        <div>
                                            <div class="text-sm font-medium text-gray-900">INV-2024-08-001</div>
                                            <div class="text-sm text-gray-500">月額基本料金</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    2024年8月1日
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    2024年8月31日
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        月額サービス
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">¥150,000</div>
                                    <div class="text-sm text-gray-500">税込 ¥165,000</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <i class="fas fa-check mr-1"></i>支払い済み
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                    <button class="text-blue-600 hover:text-blue-700 focus-ring rounded" onclick="showBillingDetail(1)">
                                        <i class="fas fa-eye mr-1"></i>詳細
                                    </button>
                                    <button class="text-green-600 hover:text-green-700 focus-ring rounded" onclick="downloadInvoicePDF(1)">
                                        <i class="fas fa-download mr-1"></i>PDF
                                    </button>
                                </td>
                            </tr>
                            
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <i class="fas fa-file-invoice text-red-500 mr-3"></i>
                                        <div>
                                            <div class="text-sm font-medium text-gray-900">INV-2024-07-015</div>
                                            <div class="text-sm text-gray-500">緊急出動料金</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    2024年7月25日
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    2024年8月25日
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                        緊急対応
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">¥320,000</div>
                                    <div class="text-sm text-gray-500">税込 ¥352,000</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                        <i class="fas fa-clock mr-1"></i>支払い待ち
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                    <button class="text-blue-600 hover:text-blue-700 focus-ring rounded" onclick="showBillingDetail(2)">
                                        <i class="fas fa-eye mr-1"></i>詳細
                                    </button>
                                    <button class="text-green-600 hover:text-green-700 focus-ring rounded" onclick="downloadInvoicePDF(2)">
                                        <i class="fas fa-download mr-1"></i>PDF
                                    </button>
                                    <button class="text-purple-600 hover:text-purple-700 focus-ring rounded" onclick="showPaymentOptions(2)">
                                        <i class="fas fa-credit-card mr-1"></i>支払い
                                    </button>
                                </td>
                            </tr>

                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <i class="fas fa-file-invoice text-green-500 mr-3"></i>
                                        <div>
                                            <div class="text-sm font-medium text-gray-900">INV-2024-07-008</div>
                                            <div class="text-sm text-gray-500">セキュリティ研修</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    2024年7月10日
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    2024年8月10日
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        研修・教育
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">¥80,000</div>
                                    <div class="text-sm text-gray-500">税込 ¥88,000</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <i class="fas fa-check mr-1"></i>支払い済み
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                    <button class="text-blue-600 hover:text-blue-700 focus-ring rounded" onclick="showBillingDetail(3)">
                                        <i class="fas fa-eye mr-1"></i>詳細
                                    </button>
                                    <button class="text-green-600 hover:text-green-700 focus-ring rounded" onclick="downloadInvoicePDF(3)">
                                        <i class="fas fa-download mr-1"></i>PDF
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ページネーション -->
                <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus-ring">
                            前へ
                        </button>
                        <button class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus-ring">
                            次へ
                        </button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                <span class="font-medium">1</span>-<span class="font-medium">3</span> 件中 <span class="font-medium">15</span> 件を表示
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                                <button class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 focus-ring">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="bg-primary border-primary text-white relative inline-flex items-center px-4 py-2 border text-sm font-medium focus-ring">
                                    1
                                </button>
                                <button class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium focus-ring">
                                    2
                                </button>
                                <button class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 focus-ring">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 請求書詳細モーダル -->
            <div id="billing-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
                <div class="relative top-20 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <!-- モーダルヘッダー -->
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-900">請求書詳細</h3>
                            <button id="close-billing-detail-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors focus-ring rounded">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <!-- 詳細内容（動的に更新） -->
                        <div id="billing-detail-content">
                            <!-- JavaScriptで動的に内容を挿入 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 支払いオプションモーダル -->
            <div id="payment-options-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
                <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <!-- モーダルヘッダー -->
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-900">お支払い方法選択</h3>
                            <button id="close-payment-options-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors focus-ring rounded">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <!-- 支払い方法選択 -->
                        <div class="space-y-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-medium text-blue-900 mb-2">
                                    <i class="fas fa-university mr-2"></i>銀行振込
                                </h4>
                                <p class="text-blue-700 text-sm mb-3">振込手数料はお客様負担となります</p>
                                <div class="text-sm text-blue-800">
                                    <div>銀行名: みずほ銀行</div>
                                    <div>支店名: 新宿支店 (123)</div>
                                    <div>口座種別: 普通</div>
                                    <div>口座番号: 1234567</div>
                                    <div>口座名義: カ）スマートポリス</div>
                                </div>
                                <button class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus-ring text-sm">
                                    振込情報をコピー
                                </button>
                            </div>

                            <div class="bg-green-50 p-4 rounded-lg">
                                <h4 class="font-medium text-green-900 mb-2">
                                    <i class="fas fa-credit-card mr-2"></i>クレジットカード決済
                                </h4>
                                <p class="text-green-700 text-sm mb-3">VISA・MasterCard・JCB・AMEX対応</p>
                                <button class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus-ring text-sm">
                                    カード決済へ進む
                                </button>
                            </div>

                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <h4 class="font-medium text-yellow-900 mb-2">
                                    <i class="fas fa-mobile-alt mr-2"></i>電子決済
                                </h4>
                                <p class="text-yellow-700 text-sm mb-3">PayPay・楽天Pay対応</p>
                                <div class="flex space-x-2">
                                    <button class="px-3 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 focus-ring text-sm">
                                        PayPay
                                    </button>
                                    <button class="px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus-ring text-sm">
                                        楽天Pay
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div id="page-company" class="page-content hidden fade-in">
            <h2 class="text-3xl font-bold text-gray-900 mb-6">自社情報</h2>
            <p class="text-gray-600">自社情報ページの内容（実装予定）</p>
        </div>

        <div id="page-users" class="page-content hidden fade-in client-admin-only">
            <!-- spec:c/client/users#main@v1.0 -->
            <div class="mb-6">
                <h2 class="text-3xl font-bold text-gray-900 mb-2">ユーザー管理</h2>
                <p class="text-secondary">社内ユーザーの権限と設定を管理します（ClientAdmin限定）</p>
            </div>

            <!-- アクション・フィルターエリア -->
            <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
                    <!-- 検索・フィルター -->
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                        <div class="relative">
                            <input 
                                type="text" 
                                id="user-search" 
                                placeholder="ユーザー名・メールで検索" 
                                class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-64"
                            >
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        
                        <select id="role-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">全ての権限</option>
                            <option value="ClientAdmin">管理者</option>
                            <option value="ClientUser">一般ユーザー</option>
                        </select>
                        
                        <select id="status-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">全ての状態</option>
                            <option value="active">アクティブ</option>
                            <option value="inactive">無効</option>
                        </select>
                    </div>
                    
                    <!-- アクションボタン -->
                    <div class="flex space-x-3">
                        <button 
                            id="refresh-users-btn" 
                            class="inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-gray-700 rounded-lg hover:bg-gray-50 transition-colors focus-ring"
                        >
                            <i class="fas fa-sync-alt mr-2"></i>
                            更新
                        </button>
                        <button 
                            id="add-user-btn" 
                            class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors focus-ring"
                        >
                            <i class="fas fa-user-plus mr-2"></i>
                            新規ユーザー追加
                        </button>
                    </div>
                </div>
            </div>

            <!-- ユーザー一覧テーブル -->
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-users mr-2"></i>
                        ユーザー一覧
                        <span id="users-count" class="ml-2 text-sm text-gray-500">(0名)</span>
                    </h3>
                </div>
                
                <!-- デスクトップ用テーブル表示 -->
                <div class="overflow-x-auto desktop-table">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ユーザー情報
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    権限レベル
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    状態
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    最終ログイン
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    操作
                                </th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- JavaScript で動的に追加 -->
                        </tbody>
                    </table>
                </div>

                <!-- 📱 モバイル用カード表示 -->
                <div class="mobile-card-view space-y-3">
                    <div id="users-cards-container">
                        <!-- JavaScript で動的に追加 -->
                    </div>
                </div>
            </div>

            <!-- ページネーション -->
            <div class="mt-6 flex justify-between items-center">
                <div class="text-sm text-gray-500">
                    <span id="users-pagination-info">1-10 of 25 users</span>
                </div>
                <div class="flex space-x-2">
                    <button id="users-prev-page" class="px-3 py-2 border border-gray-300 bg-white text-gray-700 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button id="users-next-page" class="px-3 py-2 border border-gray-300 bg-white text-gray-700 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- ユーザー編集モーダル -->
            <div id="user-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900" id="modal-title">ユーザー編集</h3>
                        </div>
                        
                        <form id="user-edit-form" class="p-6 space-y-4">
                            <input type="hidden" id="edit-user-id" name="userId">
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    ユーザー名 <span class="text-red-500">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="edit-user-name" 
                                    name="userName"
                                    required 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                >
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    メールアドレス <span class="text-red-500">*</span>
                                </label>
                                <input 
                                    type="email" 
                                    id="edit-user-email" 
                                    name="userEmail"
                                    required 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                >
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    権限レベル <span class="text-red-500">*</span>
                                </label>
                                <select 
                                    id="edit-user-role" 
                                    name="userRole"
                                    required 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                >
                                    <option value="">選択してください</option>
                                    <option value="ClientAdmin">管理者（全権限）</option>
                                    <option value="ClientUser">一般ユーザー（閲覧・申請のみ）</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">状態</label>
                                <select 
                                    id="edit-user-status" 
                                    name="userStatus"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                >
                                    <option value="active">アクティブ</option>
                                    <option value="inactive">無効</option>
                                </select>
                            </div>
                        </form>
                        
                        <div class="px-6 py-4 border-t border-gray-200 flex space-x-3">
                            <button 
                                id="save-user-btn" 
                                class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors focus-ring"
                            >
                                <i class="fas fa-save mr-2"></i>保存
                            </button>
                            <button 
                                id="cancel-edit-btn" 
                                class="flex-1 border border-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-50 transition-colors focus-ring"
                            >
                                キャンセル
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- アクティビティログセクション -->
            <div class="mt-8 bg-white rounded-lg shadow-sm">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-history mr-2"></i>
                        最近のアクティビティ
                    </h3>
                </div>
                
                <div class="p-6">
                    <div id="activity-log" class="space-y-4">
                        <!-- JavaScript で動的に追加 -->
                    </div>
                    
                    <div class="mt-4 text-center">
                        <button 
                            id="load-more-activity-btn" 
                            class="text-blue-600 hover:text-blue-800 text-sm focus-ring rounded"
                        >
                            さらに読み込む
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-settings" class="page-content hidden fade-in">
            <h2 class="text-3xl font-bold text-gray-900 mb-6">設定</h2>
            <p class="text-gray-600">設定ページの内容（実装予定）</p>
        </div>

        <!-- 📊 レポート・分析ページ -->
        <div id="page-reports" class="page-content hidden fade-in">
            <!-- spec:c/client/reports#main@v1.0 -->
            <div class="mb-6">
                <h2 class="text-3xl font-bold text-gray-900 mb-2">レポート・分析</h2>
                <p class="text-secondary">データに基づく経営意思決定をサポートします</p>
            </div>

            <!-- レポート生成ツール -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-chart-line mr-2"></i>
                        レポート生成
                    </h3>
                    <button 
                        id="generate-custom-report-btn" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors focus-ring"
                    >
                        <i class="fas fa-plus mr-2"></i>カスタムレポート作成
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- 月次レポート -->
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border">
                        <div class="flex items-center justify-between mb-3">
                            <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-calendar-alt text-white"></i>
                            </div>
                            <span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded-full">月次</span>
                        </div>
                        <h4 class="font-semibold text-gray-900 mb-2">月次レポート</h4>
                        <p class="text-sm text-gray-600 mb-4">請求・サービス利用状況の月次まとめ</p>
                        <button 
                            onclick="reportManager.generateReport('monthly')" 
                            class="w-full px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm"
                        >
                            <i class="fas fa-download mr-2"></i>生成
                        </button>
                    </div>

                    <!-- 年次レポート -->
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border">
                        <div class="flex items-center justify-between mb-3">
                            <div class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-chart-bar text-white"></i>
                            </div>
                            <span class="text-xs bg-green-200 text-green-800 px-2 py-1 rounded-full">年次</span>
                        </div>
                        <h4 class="font-semibold text-gray-900 mb-2">年次レポート</h4>
                        <p class="text-sm text-gray-600 mb-4">年間の総合分析・トレンド分析</p>
                        <button 
                            onclick="reportManager.generateReport('yearly')" 
                            class="w-full px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors text-sm"
                        >
                            <i class="fas fa-download mr-2"></i>生成
                        </button>
                    </div>

                    <!-- コスト分析 -->
                    <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-4 rounded-lg border">
                        <div class="flex items-center justify-between mb-3">
                            <div class="w-12 h-12 bg-yellow-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-yen-sign text-white"></i>
                            </div>
                            <span class="text-xs bg-yellow-200 text-yellow-800 px-2 py-1 rounded-full">分析</span>
                        </div>
                        <h4 class="font-semibold text-gray-900 mb-2">コスト分析</h4>
                        <p class="text-sm text-gray-600 mb-4">サービス別・期間別コスト詳細</p>
                        <button 
                            onclick="reportManager.generateReport('cost')" 
                            class="w-full px-3 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition-colors text-sm"
                        >
                            <i class="fas fa-download mr-2"></i>生成
                        </button>
                    </div>

                    <!-- パフォーマンス -->
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border">
                        <div class="flex items-center justify-between mb-3">
                            <div class="w-12 h-12 bg-purple-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-tachometer-alt text-white"></i>
                            </div>
                            <span class="text-xs bg-purple-200 text-purple-800 px-2 py-1 rounded-full">KPI</span>
                        </div>
                        <h4 class="font-semibold text-gray-900 mb-2">パフォーマンス</h4>
                        <p class="text-sm text-gray-600 mb-4">KPI・ROI・満足度分析</p>
                        <button 
                            onclick="reportManager.generateReport('performance')" 
                            class="w-full px-3 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors text-sm"
                        >
                            <i class="fas fa-download mr-2"></i>生成
                        </button>
                    </div>
                </div>
            </div>

            <!-- ダッシュボード・チャート -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- 月次推移グラフ -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-line-chart mr-2"></i>
                        月次請求額推移
                    </h3>
                    <div class="relative">
                        <canvas id="monthly-chart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- サービス利用割合 -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-pie-chart mr-2"></i>
                        サービス利用割合
                    </h3>
                    <div class="relative">
                        <canvas id="service-pie-chart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- KPI カード -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-blue-500">
                    <div class="flex items-center">
                        <i class="fas fa-dollar-sign text-blue-500 text-2xl mr-3"></i>
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">今年の総支払額</h3>
                            <p class="text-2xl font-bold text-gray-900" id="kpi-total-payment">¥2,340,000</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-green-500">
                    <div class="flex items-center">
                        <i class="fas fa-calendar-check text-green-500 text-2xl mr-3"></i>
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">サービス利用回数</h3>
                            <p class="text-2xl font-bold text-gray-900" id="kpi-service-count">24回</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-yellow-500">
                    <div class="flex items-center">
                        <i class="fas fa-clock text-yellow-500 text-2xl mr-3"></i>
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">平均対応時間</h3>
                            <p class="text-2xl font-bold text-gray-900" id="kpi-response-time">2.4時間</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-purple-500">
                    <div class="flex items-center">
                        <i class="fas fa-smile text-purple-500 text-2xl mr-3"></i>
                        <div>
                            <h3 class="text-sm font-medium text-gray-500">満足度スコア</h3>
                            <p class="text-2xl font-bold text-gray-900" id="kpi-satisfaction">4.8/5.0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 過去レポート履歴 -->
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-history mr-2"></i>
                        過去のレポート
                    </h3>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">レポート名</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">種類</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">期間</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">作成日</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="reports-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- JavaScript で動的に追加 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- ベネフィット/デメリット説明（ページ下部） -->
    <div class="bg-blue-50 py-8 mt-12 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h4 class="font-semibold text-success mb-2">
                        <i class="fas fa-check-circle mr-2"></i>記録の一元化
                    </h4>
                    <p class="text-sm text-gray-600">相談・申請・資料・請求が一つの場所で管理できます</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h4 class="font-semibold text-success mb-2">
                        <i class="fas fa-clock mr-2"></i>初動の迅速化
                    </h4>
                    <p class="text-sm text-gray-600">緊急連絡先・申請・相談が迷わず使えます</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h4 class="font-semibold text-warning mb-2">
                        <i class="fas fa-info-circle mr-2"></i>最初の入力に手間
                    </h4>
                    <p class="text-sm text-gray-600">初回に自社情報や担当者の登録が必要です（1回で完了）</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 用語のやさしい説明（固定ボックス） -->
    <div class="bg-gray-100 py-6 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h4 class="font-semibold text-gray-900 mb-4">
                <i class="fas fa-question-circle mr-2"></i>用語説明
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <div><strong>リスク管理:</strong> 事故やトラブルを減らすための準備</div>
                <div><strong>危機管理:</strong> 大きなトラブルが起きた時の動き方</div>
                <div><strong>インシデント:</strong> 1件ごとの出来事（相談や事件）</div>
                <div><strong>申請:</strong> スマートポリスに公式に依頼すること</div>
                <div><strong>アーカイブ:</strong> 古いデータを保管する場所</div>
                <div><strong>PDF:</strong> 紙のように表示・印刷できるファイル形式</div>
            </div>
        </div>
    </div>

    <!-- 📱 モバイル専用下部ナビゲーション -->
    <nav class="mobile-bottom-nav md:hidden" id="mobile-bottom-nav">
        <div class="mobile-nav-grid">
            <!-- メインナビ項目（4つ選抜） -->
            <a href="/c/dashboard" class="mobile-nav-item nav-link" data-page="dashboard">
                <i class="fas fa-home"></i>
                <span>ホーム</span>
            </a>
            <a href="/c/messages" class="mobile-nav-item nav-link" data-page="messages">
                <i class="fas fa-comments"></i>
                <span>相談</span>
            </a>
            <a href="/c/billing" class="mobile-nav-item nav-link" data-page="billing">
                <i class="fas fa-receipt"></i>
                <span>請求</span>
            </a>
            <button class="mobile-nav-item" id="mobile-menu-toggle">
                <i class="fas fa-ellipsis-h"></i>
                <span>その他</span>
            </button>
        </div>
    </nav>

    <!-- モバイル専用メニューオーバーレイ -->
    <div class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden" id="mobile-menu-overlay">
        <div class="fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl p-6 transform transition-transform duration-300" id="mobile-menu-sheet">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-gray-900">メニュー</h3>
                <button class="text-gray-400 hover:text-gray-600" id="mobile-menu-close">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-3 gap-4 mb-6">
                <a href="/c/services" class="mobile-nav-item nav-link text-center p-4 border rounded-lg hover:bg-gray-50" data-page="services">
                    <i class="fas fa-concierge-bell text-2xl mb-2"></i>
                    <div class="text-sm font-medium">申請</div>
                </a>
                <a href="/c/announcements" class="mobile-nav-item nav-link text-center p-4 border rounded-lg hover:bg-gray-50" data-page="announcements">
                    <i class="fas fa-bullhorn text-2xl mb-2"></i>
                    <div class="text-sm font-medium">お知らせ</div>
                </a>
                <a href="/c/seminars" class="mobile-nav-item nav-link text-center p-4 border rounded-lg hover:bg-gray-50" data-page="seminars">
                    <i class="fas fa-calendar-alt text-2xl mb-2"></i>
                    <div class="text-sm font-medium">セミナー</div>
                </a>
                <a href="/c/materials" class="mobile-nav-item nav-link text-center p-4 border rounded-lg hover:bg-gray-50" data-page="materials">
                    <i class="fas fa-folder-open text-2xl mb-2"></i>
                    <div class="text-sm font-medium">資料室</div>
                </a>
                <a href="/c/users" class="mobile-nav-item nav-link text-center p-4 border rounded-lg hover:bg-gray-50 client-admin-only" data-page="users">
                    <i class="fas fa-users text-2xl mb-2"></i>
                    <div class="text-sm font-medium">ユーザー</div>
                </a>
                <a href="/c/settings" class="mobile-nav-item nav-link text-center p-4 border rounded-lg hover:bg-gray-50" data-page="settings">
                    <i class="fas fa-cog text-2xl mb-2"></i>
                    <div class="text-sm font-medium">設定</div>
                </a>
            </div>
            
            <!-- 緊急連絡 -->
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex items-center text-red-700 mb-2">
                    <i class="fas fa-phone-alt mr-2"></i>
                    <span class="font-semibold">緊急連絡</span>
                </div>
                <a href="tel:0120-999-119" class="text-red-600 font-bold text-lg">24時間 0120-999-119</a>
            </div>
        </div>
    </div>

    <!-- PWA インストールプロンプト -->
    <div class="pwa-install-prompt" id="pwa-install-prompt">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-mobile-alt text-2xl mr-3"></i>
                <div>
                    <div class="font-semibold">アプリとして追加</div>
                    <div class="text-sm opacity-80">より快適にご利用いただけます</div>
                </div>
            </div>
            <div class="flex space-x-2">
                <button class="px-3 py-1 bg-white bg-opacity-20 rounded text-sm" id="pwa-dismiss">後で</button>
                <button class="px-3 py-1 bg-white text-gray-900 rounded text-sm font-medium" id="pwa-install">追加</button>
            </div>
        </div>
    </div>

    <!-- 🔔 通知設定モーダル -->
    <div id="notification-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-lg w-full">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">通知設定</h3>
                </div>
                
                <div class="p-6 space-y-6">
                    <!-- 通知カテゴリー -->
                    <div>
                        <h4 class="font-medium text-gray-900 mb-4">通知の種類</h4>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-credit-card text-blue-500 mr-3"></i>
                                    <div>
                                        <div class="font-medium text-gray-900">支払い関連</div>
                                        <div class="text-sm text-gray-500">請求書・支払期限・延滞通知</div>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-exclamation-triangle text-yellow-500 mr-3"></i>
                                    <div>
                                        <div class="font-medium text-gray-900">緊急・重要</div>
                                        <div class="text-sm text-gray-500">セキュリティ・システム重要更新</div>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-info-circle text-green-500 mr-3"></i>
                                    <div>
                                        <div class="font-medium text-gray-900">一般情報</div>
                                        <div class="text-sm text-gray-500">お知らせ・セミナー・新機能</div>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 通知タイミング -->
                    <div>
                        <h4 class="font-medium text-gray-900 mb-4">支払期限の通知タイミング</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded border-gray-300 text-blue-600 mr-3" checked>
                                <span class="text-gray-700">14日前</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded border-gray-300 text-blue-600 mr-3" checked>
                                <span class="text-gray-700">7日前</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded border-gray-300 text-blue-600 mr-3" checked>
                                <span class="text-gray-700">3日前</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded border-gray-300 text-blue-600 mr-3" checked>
                                <span class="text-gray-700">当日</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded border-gray-300 text-blue-600 mr-3" checked>
                                <span class="text-gray-700">延滞時</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 通知方法 -->
                    <div>
                        <h4 class="font-medium text-gray-900 mb-4">通知方法</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded border-gray-300 text-blue-600 mr-3" checked>
                                <span class="text-gray-700">ブラウザ通知</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded border-gray-300 text-blue-600 mr-3">
                                <span class="text-gray-700">メール通知（実装予定）</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                    <button id="cancel-notification-settings" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors focus-ring">
                        キャンセル
                    </button>
                    <button id="save-notification-settings" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors focus-ring">
                        保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 🚨 通知トースト（右上表示） -->
    <div id="notification-toast-container" class="fixed top-4 right-4 space-y-2 z-50">
        <!-- JavaScript で動的に追加 -->
    </div>

    <!-- フッター -->
    <footer class="bg-gray-800 text-white py-8 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h5 class="font-semibold mb-3">お困りの時は</h5>
                    <p class="text-sm text-gray-300 mb-2">まず相談を投稿してください。</p>
                    <p class="text-sm text-gray-300">緊急の場合は電話連絡も合わせて行ってください。</p>
                </div>
                <div>
                    <h5 class="font-semibold mb-3">問い合わせ窓口</h5>
                    <p class="text-sm text-gray-300">平日 9:00-18:00</p>
                    <p class="text-sm text-gray-300">03-1234-5678</p>
                </div>
                <div>
                    <h5 class="font-semibold mb-3">ポリシー</h5>
                    <ul class="text-sm text-gray-300 space-y-1">
                        <li><a href="#" class="hover:text-white focus-ring rounded">プライバシーポリシー</a></li>
                        <li><a href="#" class="hover:text-white focus-ring rounded">利用規約</a></li>
                    </ul>
                </div>
                <div>
                    <h5 class="font-semibold mb-3">システム情報</h5>
                    <p class="text-sm text-gray-300">バージョン: v1.0.0</p>
                    <p class="text-sm text-gray-300">更新日: 2024-08-28</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        // ページナビゲーション制御
        class ClientPortal {
            constructor() {
                this.currentPage = 'dashboard';
                this.userRole = 'ClientAdmin'; // ClientAdmin or ClientUser
                this.init();
            }

            init() {
                this.setupNavigation();
                this.setupMobileMenu();
                this.setupEnhancedMobile();
                this.setupPWA();
                this.setupUserRole();
                this.showPage('dashboard');
                
                console.log('スマートポリス クライアントポータル v1.0 初期化完了');
            }

            // ナビゲーション設定
            setupNavigation() {
                const navLinks = document.querySelectorAll('.nav-link, .mobile-nav-link');
                
                navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = link.dataset.page;
                        this.showPage(page);
                    });
                });
            }

            // モバイルメニュー設定
            setupMobileMenu() {
                const mobileMenuBtn = document.getElementById('mobile-menu-btn');
                const mobileNav = document.getElementById('mobile-nav');
                
                if (mobileMenuBtn && mobileNav) {
                    mobileMenuBtn.addEventListener('click', () => {
                        mobileNav.classList.toggle('hidden');
                    });
                }
            }

            // 📱 強化されたモバイル機能設定
            setupEnhancedMobile() {
                // モバイル下部ナビゲーション
                this.setupBottomNavigation();
                
                // モバイルメニューオーバーレイ
                this.setupMobileMenuOverlay();
                
                // スワイプジェスチャー
                this.setupSwipeGestures();
                
                // モーダルのモバイル最適化
                this.optimizeModalsForMobile();
            }

            // 下部ナビゲーション
            setupBottomNavigation() {
                const bottomNavLinks = document.querySelectorAll('.mobile-nav-item[data-page]');
                bottomNavLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = link.dataset.page;
                        this.showPage(page);
                        this.updateBottomNavActive(page);
                    });
                });
            }

            // モバイルメニューオーバーレイ
            setupMobileMenuOverlay() {
                const menuToggle = document.getElementById('mobile-menu-toggle');
                const menuOverlay = document.getElementById('mobile-menu-overlay');
                const menuClose = document.getElementById('mobile-menu-close');

                if (menuToggle && menuOverlay) {
                    menuToggle.addEventListener('click', () => {
                        menuOverlay.classList.remove('hidden');
                        document.body.style.overflow = 'hidden';
                    });
                }

                if (menuClose && menuOverlay) {
                    menuClose.addEventListener('click', () => {
                        menuOverlay.classList.add('hidden');
                        document.body.style.overflow = 'auto';
                    });
                }

                // オーバーレイクリックで閉じる
                if (menuOverlay) {
                    menuOverlay.addEventListener('click', (e) => {
                        if (e.target === menuOverlay) {
                            menuOverlay.classList.add('hidden');
                            document.body.style.overflow = 'auto';
                        }
                    });
                }
            }

            // スワイプジェスチャー
            setupSwipeGestures() {
                let startX = 0;
                let startY = 0;

                document.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                });

                document.addEventListener('touchend', (e) => {
                    if (!startX || !startY) return;

                    const endX = e.changedTouches[0].clientX;
                    const endY = e.changedTouches[0].clientY;
                    const diffX = startX - endX;
                    const diffY = startY - endY;

                    // 水平スワイプが垂直スワイプより大きい場合
                    if (Math.abs(diffX) > Math.abs(diffY)) {
                        if (Math.abs(diffX) > 50) { // 50px以上のスワイプ
                            if (diffX > 0) {
                                // 左スワイプ - 次のページ
                                this.swipeToNextPage();
                            } else {
                                // 右スワイプ - 前のページ
                                this.swipeToPrevPage();
                            }
                        }
                    }

                    startX = 0;
                    startY = 0;
                });
            }

            // モーダルのモバイル最適化
            optimizeModalsForMobile() {
                const modals = document.querySelectorAll('[id$="-modal"]');
                modals.forEach(modal => {
                    if (window.innerWidth <= 480) {
                        const modalContent = modal.querySelector('.max-w-md, .max-w-lg, .max-w-xl');
                        if (modalContent) {
                            modalContent.classList.add('modal-mobile-full');
                        }
                    }
                });
            }

            // PWA設定
            setupPWA() {
                // PWAインストール対応
                let deferredPrompt;
                const installPrompt = document.getElementById('pwa-install-prompt');
                const installBtn = document.getElementById('pwa-install');
                const dismissBtn = document.getElementById('pwa-dismiss');

                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    
                    // モバイルでのみ表示
                    if (window.innerWidth <= 768) {
                        setTimeout(() => {
                            installPrompt?.classList.add('show');
                        }, 3000); // 3秒後に表示
                    }
                });

                installBtn?.addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        console.log(`PWA install ${outcome}`);
                        deferredPrompt = null;
                    }
                    installPrompt?.classList.remove('show');
                });

                dismissBtn?.addEventListener('click', () => {
                    installPrompt?.classList.remove('show');
                });
            }

            // 下部ナビのアクティブ状態更新
            updateBottomNavActive(pageId) {
                const bottomNavItems = document.querySelectorAll('.mobile-nav-item[data-page]');
                bottomNavItems.forEach(item => {
                    if (item.dataset.page === pageId) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }

            // スワイプでページ切り替え
            swipeToNextPage() {
                const pages = ['dashboard', 'messages', 'billing', 'services'];
                const currentIndex = pages.indexOf(this.currentPage);
                if (currentIndex < pages.length - 1) {
                    this.showPage(pages[currentIndex + 1]);
                }
            }

            swipeToPrevPage() {
                const pages = ['dashboard', 'messages', 'billing', 'services'];
                const currentIndex = pages.indexOf(this.currentPage);
                if (currentIndex > 0) {
                    this.showPage(pages[currentIndex - 1]);
                }
            }

            // ユーザー権限設定
            setupUserRole() {
                const adminOnlyElements = document.querySelectorAll('.client-admin-only');
                
                if (this.userRole !== 'ClientAdmin') {
                    adminOnlyElements.forEach(element => {
                        element.style.display = 'none';
                    });
                }
            }

            // ページ表示
            showPage(pageId) {
                // すべてのページを非表示
                const allPages = document.querySelectorAll('.page-content');
                allPages.forEach(page => {
                    page.classList.add('hidden');
                });

                // 指定ページを表示
                const targetPage = document.getElementById(`page-${pageId}`);
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                    this.currentPage = pageId;
                    this.updateNavigation(pageId);
                    this.updateBreadcrumb(pageId);
                    window.scrollTo(0, 0);
                }
            }

            // ナビゲーション状態更新
            updateNavigation(pageId) {
                const allNavLinks = document.querySelectorAll('.nav-link, .mobile-nav-link');
                
                allNavLinks.forEach(link => {
                    if (link.dataset.page === pageId) {
                        // アクティブ状態
                        if (link.classList.contains('nav-link')) {
                            link.className = 'nav-link text-white border-b-2 border-white px-2 pb-1 text-sm font-medium whitespace-nowrap transition-colors focus-ring rounded';
                        } else {
                            link.className = 'mobile-nav-link block px-3 py-2 text-white bg-blue-600 rounded-md transition-colors';
                        }
                    } else {
                        // 非アクティブ状態
                        if (link.classList.contains('nav-link')) {
                            link.className = 'nav-link text-blue-100 hover:text-white px-2 pb-1 text-sm font-medium whitespace-nowrap transition-colors focus-ring rounded';
                        } else {
                            link.className = 'mobile-nav-link block px-3 py-2 text-blue-100 hover:bg-blue-600 rounded-md transition-colors';
                        }
                    }
                });
            }

            // パンくず更新
            updateBreadcrumb(pageId) {
                const breadcrumb = document.getElementById('breadcrumb');
                const pageNames = {
                    'dashboard': 'ホーム',
                    'announcements': 'お知らせ',
                    'messages': '相談・連絡',
                    'services': '申請（サービス）',
                    'materials': '資料室',
                    'seminars': 'セミナー',
                    'billing': '請求・お支払い',
                    'company': '自社情報',
                    'users': 'ユーザー管理',
                    'settings': '設定'
                };

                if (pageId === 'dashboard') {
                    breadcrumb.innerHTML = '<a href="/c/dashboard" class="hover:text-primary focus-ring rounded">ホーム</a>';
                } else {
                    breadcrumb.innerHTML = `
                        <a href="/c/dashboard" class="hover:text-primary focus-ring rounded">ホーム</a>
                        <span class="mx-2">＞</span>
                        <span class="text-gray-900">${pageNames[pageId] || pageId}</span>
                    `;
                }
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            window.clientPortal = new ClientPortal();
            window.messagesManager = new MessagesManager();
            window.servicesManager = new ServicesManager();
            window.billingManager = new BillingManager();
            window.userManager = new UserManager();
            window.notificationManager = new NotificationManager();
            window.reportManager = new ReportManager();
        });

        // 相談・連絡管理クラス
        class MessagesManager {
            constructor() {
                this.baseURL = 'http://localhost:3001/api';
                this.messages = [];
                this.setupEventListeners();
                this.loadMessages(); // 初期データ読み込み
            }

            setupEventListeners() {
                // 新規相談ボタン
                document.getElementById('new-message-btn')?.addEventListener('click', () => {
                    this.showNewMessageModal();
                });

                // モーダル閉じる
                document.getElementById('close-modal-btn')?.addEventListener('click', () => {
                    this.hideNewMessageModal();
                });

                document.getElementById('close-detail-modal-btn')?.addEventListener('click', () => {
                    this.hideDetailModal();
                });

                document.getElementById('cancel-btn')?.addEventListener('click', () => {
                    this.hideNewMessageModal();
                });

                // フォーム送信
                document.getElementById('new-message-form')?.addEventListener('submit', (e) => {
                    this.handleFormSubmit(e);
                });

                // ファイル選択
                document.getElementById('message-files')?.addEventListener('change', (e) => {
                    this.handleFileSelection(e);
                });

                // フィルター
                document.getElementById('status-filter')?.addEventListener('change', () => {
                    this.filterMessages();
                });

                document.getElementById('priority-filter')?.addEventListener('change', () => {
                    this.filterMessages();
                });

                document.getElementById('search-messages')?.addEventListener('input', () => {
                    this.filterMessages();
                });
            }

            showNewMessageModal() {
                document.getElementById('new-message-modal').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            hideNewMessageModal() {
                document.getElementById('new-message-modal').classList.add('hidden');
                document.body.style.overflow = 'auto';
                this.resetForm();
            }

            hideDetailModal() {
                document.getElementById('message-detail-modal').classList.add('hidden');
                document.body.style.overflow = 'auto';
            }

            resetForm() {
                document.getElementById('new-message-form').reset();
                document.getElementById('selected-files').innerHTML = '';
            }

            handleFormSubmit(e) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const messageData = {
                    subject: formData.get('subject'),
                    content: formData.get('content'),
                    priority: formData.get('priority'),
                    category: formData.get('category'),
                    contact_name: formData.get('contact_name'),
                    contact_phone: formData.get('contact_phone'),
                    requested_action: formData.get('requested_action')
                };

                // 送信処理（仮実装）
                this.submitMessage(messageData);
            }

            async submitMessage(messageData) {
                try {
                    // 送信アニメーション
                    const submitBtn = document.querySelector('#new-message-form button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>送信中...';
                    submitBtn.disabled = true;

                    // 実際のAPIに送信
                    const response = await fetch(`${this.baseURL}/messages`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(messageData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        // 成功メッセージ
                        alert('相談を送信しました。担当者から回答をお待ちください。');
                        this.hideNewMessageModal();
                        this.refreshMessageList(); // リストを更新
                    } else {
                        throw new Error(result.error || '送信に失敗しました');
                    }
                    
                    // ボタンを元に戻す
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;

                } catch (error) {
                    console.error('送信エラー:', error);
                    alert('送信に失敗しました。しばらく時間をおいて再度お試しください。');
                    
                    // ボタンを元に戻す
                    const submitBtn = document.querySelector('#new-message-form button[type="submit"]');
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>相談を送信';
                    submitBtn.disabled = false;
                }
            }

            handleFileSelection(e) {
                const files = e.target.files;
                const selectedFilesDiv = document.getElementById('selected-files');
                selectedFilesDiv.innerHTML = '';

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileItem = document.createElement('div');
                    fileItem.className = 'flex items-center justify-between p-2 bg-gray-50 rounded';
                    fileItem.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-file text-gray-400 mr-2"></i>
                            <span class="text-sm">${file.name}</span>
                            <span class="text-xs text-gray-500 ml-2">(${(file.size / 1024).toFixed(1)}KB)</span>
                        </div>
                        <button type="button" onclick="this.parentElement.remove()" 
                                class="text-red-500 hover:text-red-700 focus-ring rounded">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    selectedFilesDiv.appendChild(fileItem);
                }
            }

            filterMessages() {
                // フィルター機能（仮実装）
                const statusFilter = document.getElementById('status-filter').value;
                const priorityFilter = document.getElementById('priority-filter').value;
                const searchTerm = document.getElementById('search-messages').value.toLowerCase();

                console.log('フィルター適用:', { statusFilter, priorityFilter, searchTerm });
                // 実際のフィルター処理をここに実装
            }

            // APIからメッセージデータを取得
            async loadMessages() {
                try {
                    const response = await fetch(`${this.baseURL}/messages`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.messages = data.data;
                        this.updateMessageTable();
                    } else {
                        console.error('メッセージの取得に失敗しました:', data.error);
                    }
                } catch (error) {
                    console.error('APIエラー:', error);
                }
            }

            // メッセージテーブルの更新
            updateMessageTable() {
                const tbody = document.getElementById('messages-table-body');
                if (!tbody) return;

                tbody.innerHTML = '';

                this.messages.forEach(message => {
                    const row = this.createMessageRow(message);
                    tbody.appendChild(row);
                });
            }

            // メッセージ行を作成
            createMessageRow(message) {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.onclick = () => this.showMessageDetail(message.id);

                const priorityBadge = this.getPriorityBadge(message.priority);
                const statusBadge = this.getStatusBadge(message.status);
                const hasAttachments = message.attachment_count > 0;

                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            ${hasAttachments ? '<i class="fas fa-paperclip text-gray-400 mr-2"></i>' : ''}
                            <div>
                                <div class="text-sm font-medium text-gray-900">${message.subject}</div>
                                <div class="text-sm text-gray-500">${this.truncateText(message.content, 80)}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">${priorityBadge}</td>
                    <td class="px-6 py-4">${statusBadge}</td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">${message.assignee || '未割当'}</div>
                        ${message.department ? `<div class="text-sm text-gray-500">${message.department}</div>` : ''}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        ${this.formatDate(message.created_at)}
                    </td>
                    <td class="px-6 py-4 text-sm font-medium">
                        <button class="text-primary hover:text-blue-700 focus-ring rounded mr-3" onclick="event.stopPropagation(); window.messagesManager.showMessageDetail(${message.id})">
                            <i class="fas fa-eye mr-1"></i>詳細
                        </button>
                        ${message.status !== 'completed' ? `
                        <button class="text-success hover:text-green-700 focus-ring rounded" onclick="event.stopPropagation(); replyMessage(${message.id})">
                            <i class="fas fa-reply mr-1"></i>返信
                        </button>
                        ` : `
                        <button class="text-secondary hover:text-gray-600 focus-ring rounded" onclick="event.stopPropagation(); archiveMessage(${message.id})">
                            <i class="fas fa-archive mr-1"></i>保管
                        </button>
                        `}
                    </td>
                `;

                return row;
            }

            // 優先度バッジ
            getPriorityBadge(priority) {
                const badges = {
                    'high': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800"><i class="fas fa-exclamation-circle mr-1"></i>高</span>',
                    'medium': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"><i class="fas fa-minus-circle mr-1"></i>中</span>',
                    'low': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800"><i class="fas fa-circle mr-1"></i>低</span>'
                };
                return badges[priority] || badges['medium'];
            }

            // ステータスバッジ
            getStatusBadge(status) {
                const badges = {
                    'received': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">受付中</span>',
                    'in-progress': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">対応中</span>',
                    'completed': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">完了</span>',
                    'archived': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">保管</span>'
                };
                return badges[status] || badges['received'];
            }

            // テキスト切り詰め
            truncateText(text, length) {
                return text.length > length ? text.substring(0, length) + '...' : text;
            }

            // 日付フォーマット
            formatDate(dateString) {
                const date = new Date(dateString);
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                
                return `${year}/${month}/${day}<br><span class="text-xs">${hours}:${minutes}</span>`;
            }

            refreshMessageList() {
                // メッセージリスト更新
                this.loadMessages();
            }
        }

        // グローバル関数（HTMLから呼び出し用）
        function showMessageDetail(messageId) {
            if (window.messagesManager) {
                window.messagesManager.showMessageDetail(messageId);
            }
        }

        function replyMessage(messageId) {
            console.log('返信:', messageId);
            // 返信機能の実装
        }

        function archiveMessage(messageId) {
            if (confirm('この相談を保管しますか？')) {
                console.log('保管:', messageId);
                // 保管機能の実装
            }
        }

        // MessagesManagerクラスにshowMessageDetailメソッドを追加
        MessagesManager.prototype.showMessageDetail = function(messageId) {
            const message = this.messages.find(m => m.id === messageId);
            if (!message) return;

            const modal = document.getElementById('message-detail-modal');
            const content = document.getElementById('message-detail-content');
            
            const statusLabels = {
                'received': '受付中',
                'in-progress': '対応中',
                'completed': '完了'
            };

            const priorityLabels = {
                'high': '高',
                'medium': '中',
                'low': '低'
            };

            const priorityColors = {
                'high': 'bg-red-100 text-red-800',
                'medium': 'bg-yellow-100 text-yellow-800',
                'low': 'bg-gray-100 text-gray-800'
            };

            const statusColors = {
                'received': 'bg-blue-100 text-blue-800',
                'in-progress': 'bg-yellow-100 text-yellow-800',
                'completed': 'bg-green-100 text-green-800'
            };

            content.innerHTML = `
                <div class="space-y-6">
                    <!-- 基本情報 -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <h4 class="font-medium text-gray-900 mb-2">件名</h4>
                                <p class="text-gray-700">${message.subject}</p>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-900 mb-2">優先度</h4>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${priorityColors[message.priority]}">
                                    ${priorityLabels[message.priority]}
                                </span>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-900 mb-2">状態</h4>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColors[message.status]}">
                                    ${statusLabels[message.status]}
                                </span>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-900 mb-2">作成日時</h4>
                                <p class="text-gray-700">${new Date(message.created_at).toLocaleString('ja-JP')}</p>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-900 mb-2">担当者</h4>
                                <p class="text-gray-700">${message.assignee || '未割当'}</p>
                                ${message.department ? `<p class="text-sm text-gray-500">${message.department}</p>` : ''}
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-900 mb-2">連絡先</h4>
                                <p class="text-gray-700">${message.contact_name}</p>
                                ${message.contact_phone ? `<p class="text-sm text-gray-500">${message.contact_phone}</p>` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- 相談内容 -->
                    <div>
                        <h4 class="font-medium text-gray-900 mb-4">相談内容</h4>
                        <div class="bg-white border rounded-lg p-6">
                            <p class="text-gray-700 leading-relaxed whitespace-pre-line">${message.content}</p>
                        </div>
                    </div>

                    <!-- 添付ファイル -->
                    ${message.attachment_count > 0 ? `
                    <div>
                        <h4 class="font-medium text-gray-900 mb-4">添付ファイル</h4>
                        <div class="space-y-2">
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                <i class="fas fa-file text-gray-400 mr-3"></i>
                                <span class="flex-1 text-sm">添付ファイル ${message.attachment_count}件</span>
                                <button class="text-primary hover:text-blue-700 text-sm focus-ring rounded">
                                    <i class="fas fa-download mr-1"></i>ダウンロード
                                </button>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- アクション -->
                    <div class="flex justify-end space-x-4 pt-6 border-t">
                        <button onclick="replyMessage(${message.id})" class="px-6 py-3 bg-primary text-white rounded-md hover:bg-blue-700 transition-colors focus-ring">
                            <i class="fas fa-reply mr-2"></i>返信する
                        </button>
                        ${message.status !== 'completed' ? `
                        <button onclick="archiveMessage(${message.id})" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors focus-ring">
                            <i class="fas fa-archive mr-2"></i>保管する
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };

        // サービス申込管理クラス
        class ServicesManager {
            constructor() {
                this.baseURL = 'http://localhost:3001/api';
                this.currentService = null;
                this.currentStep = 1;
                this.formData = {};
                this.setupEventListeners();
                
                // 企業情報（実際の運用では認証情報から取得）
                this.companyInfo = {
                    company_name: '株式会社サンプル',
                    contact_person: '田中太郎',
                    email: 'tanaka@sample.co.jp',
                    phone: '03-1234-5678',
                    address: '東京都渋谷区サンプル1-2-3'
                };

                // サービス定義
                this.serviceDefinitions = {
                    'customer-harassment': {
                        name: 'カスハラ出動依頼',
                        category: 'emergency',
                        fields: [
                            { name: 'incident_location', label: '発生場所', type: 'text', required: true },
                            { name: 'incident_description', label: '状況詳細', type: 'textarea', required: true },
                            { name: 'customer_info', label: '顧客情報', type: 'textarea', required: false },
                            { name: 'urgency_level', label: '緊急度', type: 'select', options: [
                                { value: 'immediate', label: '即時対応必要' },
                                { value: 'urgent', label: '1時間以内' },
                                { value: 'high', label: '3時間以内' }
                            ], required: true },
                            { name: 'preferred_time', label: '希望対応時間', type: 'datetime-local', required: true }
                        ]
                    },
                    'security-seal': {
                        name: 'セキュリティシール',
                        category: 'security',
                        fields: [
                            { name: 'seal_type', label: 'シールタイプ', type: 'select', options: [
                                { value: 'standard', label: '標準タイプ' },
                                { value: 'custom', label: 'カスタムデザイン' },
                                { value: 'reflective', label: '反射材タイプ' }
                            ], required: true },
                            { name: 'quantity', label: '枚数', type: 'number', required: true },
                            { name: 'installation_location', label: '設置場所', type: 'textarea', required: true },
                            { name: 'design_requirements', label: 'デザイン要望', type: 'textarea', required: false },
                            { name: 'delivery_date', label: '希望納期', type: 'date', required: true }
                        ]
                    },
                    'security-training': {
                        name: 'セキュリティ研修',
                        category: 'training',
                        fields: [
                            { name: 'training_type', label: '研修タイプ', type: 'select', options: [
                                { value: 'basic', label: '基本セキュリティ研修' },
                                { value: 'advanced', label: '上級リスク管理' },
                                { value: 'customer-service', label: '接客セキュリティ' }
                            ], required: true },
                            { name: 'participant_count', label: '参加人数', type: 'number', required: true },
                            { name: 'preferred_date', label: '希望日時', type: 'datetime-local', required: true },
                            { name: 'duration_hours', label: '研修時間', type: 'select', options: [
                                { value: '2', label: '2時間' },
                                { value: '3', label: '3時間' },
                                { value: '6', label: '6時間（1日）' }
                            ], required: true },
                            { name: 'special_requirements', label: '特別な要望', type: 'textarea', required: false }
                        ]
                    },
                    'risk-assessment': {
                        name: 'リスク診断',
                        category: 'consulting',
                        fields: [
                            { name: 'assessment_scope', label: '診断範囲', type: 'checkbox', options: [
                                { value: 'physical', label: '物理的セキュリティ' },
                                { value: 'personnel', label: '人的セキュリティ' },
                                { value: 'information', label: '情報セキュリティ' },
                                { value: 'operational', label: '運用セキュリティ' }
                            ], required: true },
                            { name: 'facility_size', label: '施設規模', type: 'select', options: [
                                { value: 'small', label: '小規模（~500㎡）' },
                                { value: 'medium', label: '中規模（500-2000㎡）' },
                                { value: 'large', label: '大規模（2000㎡~）' }
                            ], required: true },
                            { name: 'employee_count', label: '従業員数', type: 'number', required: true },
                            { name: 'preferred_schedule', label: '希望実施日', type: 'date', required: true },
                            { name: 'current_concerns', label: '現在の懸念事項', type: 'textarea', required: false }
                        ]
                    },
                    'security-guard': {
                        name: '警備員派遣',
                        category: 'emergency',
                        fields: [
                            { name: 'guard_type', label: '警備タイプ', type: 'select', options: [
                                { value: 'facility', label: '施設警備' },
                                { value: 'event', label: 'イベント警備' },
                                { value: 'vip', label: 'VIP警護' }
                            ], required: true },
                            { name: 'guard_count', label: '必要人数', type: 'number', required: true },
                            { name: 'start_datetime', label: '開始日時', type: 'datetime-local', required: true },
                            { name: 'end_datetime', label: '終了日時', type: 'datetime-local', required: true },
                            { name: 'location_details', label: '警備場所詳細', type: 'textarea', required: true },
                            { name: 'special_instructions', label: '特別な指示', type: 'textarea', required: false }
                        ]
                    },
                    'security-camera': {
                        name: '防犯カメラ設置',
                        category: 'security',
                        fields: [
                            { name: 'camera_count', label: '設置台数', type: 'number', required: true },
                            { name: 'camera_type', label: 'カメラタイプ', type: 'select', options: [
                                { value: 'indoor', label: '屋内用' },
                                { value: 'outdoor', label: '屋外用' },
                                { value: 'mixed', label: '屋内外混合' }
                            ], required: true },
                            { name: 'recording_system', label: '録画システム', type: 'select', options: [
                                { value: 'local', label: 'ローカル録画' },
                                { value: 'cloud', label: 'クラウド録画' },
                                { value: 'hybrid', label: 'ハイブリッド' }
                            ], required: true },
                            { name: 'installation_locations', label: '設置場所', type: 'textarea', required: true },
                            { name: 'budget_range', label: '予算範囲', type: 'select', options: [
                                { value: '200k', label: '20万円以下' },
                                { value: '500k', label: '20-50万円' },
                                { value: '1000k', label: '50-100万円' },
                                { value: '1000k+', label: '100万円以上' }
                            ], required: true }
                        ]
                    },
                    'legal-document': {
                        name: '法的書類作成',
                        category: 'consulting',
                        fields: [
                            { name: 'document_type', label: '書類タイプ', type: 'select', options: [
                                { value: 'warning', label: '警告書' },
                                { value: 'cease_desist', label: '内容証明郵便' },
                                { value: 'contract', label: '契約書' },
                                { value: 'agreement', label: '合意書' }
                            ], required: true },
                            { name: 'target_party', label: '相手方情報', type: 'textarea', required: true },
                            { name: 'case_description', label: '案件概要', type: 'textarea', required: true },
                            { name: 'desired_outcome', label: '希望する結果', type: 'textarea', required: true },
                            { name: 'urgency', label: '緊急度', type: 'select', options: [
                                { value: 'immediate', label: '即日' },
                                { value: 'urgent', label: '3日以内' },
                                { value: 'normal', label: '1週間以内' }
                            ], required: true }
                        ]
                    },
                    'emergency-consulting': {
                        name: '緊急コンサルティング',
                        category: 'emergency',
                        fields: [
                            { name: 'emergency_type', label: '緊急事態の種類', type: 'select', options: [
                                { value: 'harassment', label: '顧客トラブル' },
                                { value: 'security_breach', label: 'セキュリティ侵害' },
                                { value: 'threat', label: '脅迫・恐喝' },
                                { value: 'other', label: 'その他' }
                            ], required: true },
                            { name: 'situation_description', label: '現在の状況', type: 'textarea', required: true },
                            { name: 'immediate_risk', label: '緊急性の理由', type: 'textarea', required: true },
                            { name: 'contact_method', label: '希望連絡方法', type: 'select', options: [
                                { value: 'phone', label: '電話' },
                                { value: 'site_visit', label: '現地対応' },
                                { value: 'video_call', label: 'ビデオ通話' }
                            ], required: true },
                            { name: 'availability', label: '対応可能時間', type: 'text', required: true }
                        ]
                    }
                };
            }

            setupEventListeners() {
                // モーダル関連
                document.getElementById('close-service-modal-btn')?.addEventListener('click', () => {
                    this.hideServiceModal();
                });

                document.getElementById('service-cancel-btn')?.addEventListener('click', () => {
                    this.hideServiceModal();
                });

                document.getElementById('service-prev-btn')?.addEventListener('click', () => {
                    this.previousStep();
                });

                document.getElementById('service-next-btn')?.addEventListener('click', () => {
                    this.nextStep();
                });

                // フィルター機能
                document.getElementById('service-category-filter')?.addEventListener('change', () => {
                    this.filterServices();
                });

                document.getElementById('service-urgency-filter')?.addEventListener('change', () => {
                    this.filterServices();
                });

                document.getElementById('service-search')?.addEventListener('input', () => {
                    this.filterServices();
                });
            }

            openServiceApplication(serviceType) {
                this.currentService = serviceType;
                this.currentStep = 1;
                this.formData = { ...this.companyInfo }; // 企業情報をコピー
                
                const serviceDef = this.serviceDefinitions[serviceType];
                if (!serviceDef) return;

                // モーダルタイトル更新
                document.getElementById('service-modal-title').textContent = serviceDef.name + ' 申込';
                
                // ステップ1の内容表示
                this.renderStep1();
                this.showServiceModal();
            }

            showServiceModal() {
                document.getElementById('service-application-modal').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            hideServiceModal() {
                document.getElementById('service-application-modal').classList.add('hidden');
                document.body.style.overflow = 'auto';
                this.resetForm();
            }

            resetForm() {
                this.currentService = null;
                this.currentStep = 1;
                this.formData = {};
            }

            renderStep1() {
                const serviceDef = this.serviceDefinitions[this.currentService];
                const content = document.getElementById('service-form-content');
                
                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="bg-blue-50 p-6 rounded-lg">
                            <h4 class="font-semibold text-blue-900 mb-2">${serviceDef.name}</h4>
                            <p class="text-blue-700 text-sm">サービス詳細を確認し、必要な情報を入力してください。</p>
                        </div>

                        <!-- 企業情報表示（自動入力済み） -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h5 class="font-medium text-gray-900 mb-3">申込企業情報（自動入力済み）</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="font-medium text-gray-700">企業名:</span>
                                    <span class="ml-2 text-gray-900">${this.companyInfo.company_name}</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">担当者:</span>
                                    <span class="ml-2 text-gray-900">${this.companyInfo.contact_person}</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">電話番号:</span>
                                    <span class="ml-2 text-gray-900">${this.companyInfo.phone}</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">メールアドレス:</span>
                                    <span class="ml-2 text-gray-900">${this.companyInfo.email}</span>
                                </div>
                            </div>
                        </div>

                        <div class="text-center">
                            <p class="text-gray-600">企業情報は自動で入力されています。<br>次のステップでサービス詳細を入力してください。</p>
                        </div>
                    </div>
                `;

                this.updateStepIndicator(1);
                this.updateButtons();
            }

            renderStep2() {
                const serviceDef = this.serviceDefinitions[this.currentService];
                const content = document.getElementById('service-form-content');
                
                let fieldsHTML = serviceDef.fields.map(field => this.renderField(field)).join('');
                
                content.innerHTML = `
                    <form id="service-detail-form" class="space-y-6">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-green-900 mb-2">サービス詳細入力</h4>
                            <p class="text-green-700 text-sm">必要な情報を入力してください。（<span class="text-red-600">*</span>は必須項目）</p>
                        </div>
                        ${fieldsHTML}
                    </form>
                `;

                this.updateStepIndicator(2);
                this.updateButtons();
            }

            renderStep3() {
                const serviceDef = this.serviceDefinitions[this.currentService];
                const content = document.getElementById('service-form-content');
                
                // フォームデータの確認表示
                let confirmationHTML = '';
                serviceDef.fields.forEach(field => {
                    const value = this.formData[field.name];
                    if (value) {
                        confirmationHTML += `
                            <div class="flex justify-between py-2 border-b">
                                <span class="font-medium text-gray-700">${field.label}:</span>
                                <span class="text-gray-900">${this.formatFieldValue(field, value)}</span>
                            </div>
                        `;
                    }
                });

                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-yellow-900 mb-2">申込内容確認</h4>
                            <p class="text-yellow-700 text-sm">以下の内容で申込を行います。間違いがないかご確認ください。</p>
                        </div>

                        <!-- 企業情報 -->
                        <div>
                            <h5 class="font-semibold text-gray-900 mb-3">企業情報</h5>
                            <div class="bg-gray-50 p-4 rounded">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="flex justify-between">
                                        <span class="font-medium text-gray-700">企業名:</span>
                                        <span class="text-gray-900">${this.companyInfo.company_name}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-medium text-gray-700">担当者:</span>
                                        <span class="text-gray-900">${this.companyInfo.contact_person}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- サービス詳細 -->
                        <div>
                            <h5 class="font-semibold text-gray-900 mb-3">申込サービス: ${serviceDef.name}</h5>
                            <div class="bg-white border rounded p-4">
                                ${confirmationHTML}
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-blue-700 text-sm">
                                <i class="fas fa-info-circle mr-2"></i>
                                申込送信後、担当者より詳細の確認連絡をいたします。緊急性の高いサービスについては、可能な限り迅速に対応いたします。
                            </p>
                        </div>
                    </div>
                `;

                this.updateStepIndicator(3);
                this.updateButtons();
            }

            renderField(field) {
                let fieldHTML = '';
                const required = field.required ? 'required' : '';
                const requiredMark = field.required ? '<span class="text-red-600">*</span>' : '';

                switch (field.type) {
                    case 'text':
                    case 'email':
                    case 'tel':
                    case 'number':
                    case 'date':
                    case 'datetime-local':
                        fieldHTML = `
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ${field.label} ${requiredMark}
                                </label>
                                <input type="${field.type}" name="${field.name}" ${required}
                                       class="w-full border-gray-300 rounded-md focus-ring"
                                       placeholder="${field.placeholder || ''}">
                            </div>
                        `;
                        break;

                    case 'textarea':
                        fieldHTML = `
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ${field.label} ${requiredMark}
                                </label>
                                <textarea name="${field.name}" rows="4" ${required}
                                          class="w-full border-gray-300 rounded-md focus-ring"
                                          placeholder="${field.placeholder || ''}"></textarea>
                            </div>
                        `;
                        break;

                    case 'select':
                        const options = field.options.map(opt => 
                            `<option value="${opt.value}">${opt.label}</option>`
                        ).join('');
                        fieldHTML = `
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ${field.label} ${requiredMark}
                                </label>
                                <select name="${field.name}" ${required}
                                        class="w-full border-gray-300 rounded-md focus-ring">
                                    <option value="">選択してください</option>
                                    ${options}
                                </select>
                            </div>
                        `;
                        break;

                    case 'checkbox':
                        const checkboxes = field.options.map(opt => `
                            <label class="flex items-center">
                                <input type="checkbox" name="${field.name}" value="${opt.value}"
                                       class="rounded border-gray-300 text-primary focus:ring-primary">
                                <span class="ml-2 text-sm text-gray-700">${opt.label}</span>
                            </label>
                        `).join('');
                        fieldHTML = `
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ${field.label} ${requiredMark}
                                </label>
                                <div class="space-y-2">
                                    ${checkboxes}
                                </div>
                            </div>
                        `;
                        break;
                }

                return fieldHTML;
            }

            formatFieldValue(field, value) {
                if (field.type === 'checkbox') {
                    return Array.isArray(value) ? value.join(', ') : value;
                } else if (field.type === 'select') {
                    const option = field.options?.find(opt => opt.value === value);
                    return option ? option.label : value;
                }
                return value;
            }

            nextStep() {
                if (this.currentStep === 1) {
                    this.currentStep = 2;
                    this.renderStep2();
                } else if (this.currentStep === 2) {
                    if (this.validateStep2()) {
                        this.saveStep2Data();
                        this.currentStep = 3;
                        this.renderStep3();
                    }
                } else if (this.currentStep === 3) {
                    this.submitApplication();
                }
            }

            previousStep() {
                if (this.currentStep === 2) {
                    this.currentStep = 1;
                    this.renderStep1();
                } else if (this.currentStep === 3) {
                    this.currentStep = 2;
                    this.renderStep2();
                    // 前回入力データを復元
                    this.restoreStep2Data();
                }
            }

            validateStep2() {
                const form = document.getElementById('service-detail-form');
                return form.checkValidity();
            }

            saveStep2Data() {
                const form = document.getElementById('service-detail-form');
                const formData = new FormData(form);
                
                for (const [key, value] of formData.entries()) {
                    this.formData[key] = value;
                }

                // チェックボックスの処理
                const checkboxes = form.querySelectorAll('input[type="checkbox"]:checked');
                const checkboxGroups = {};
                checkboxes.forEach(cb => {
                    if (!checkboxGroups[cb.name]) {
                        checkboxGroups[cb.name] = [];
                    }
                    checkboxGroups[cb.name].push(cb.value);
                });
                
                Object.assign(this.formData, checkboxGroups);
            }

            restoreStep2Data() {
                const form = document.getElementById('service-detail-form');
                Object.keys(this.formData).forEach(key => {
                    const element = form.querySelector(`[name="${key}"]`);
                    if (element && element.type !== 'checkbox') {
                        element.value = this.formData[key];
                    }
                });

                // チェックボックスの復元
                Object.keys(this.formData).forEach(key => {
                    if (Array.isArray(this.formData[key])) {
                        this.formData[key].forEach(value => {
                            const checkbox = form.querySelector(`input[name="${key}"][value="${value}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                });
            }

            async submitApplication() {
                try {
                    const submitBtn = document.getElementById('service-next-btn');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>送信中...';
                    submitBtn.disabled = true;

                    // APIに送信（実装）
                    const response = await fetch(`${this.baseURL}/service-applications`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            service_type: this.currentService,
                            ...this.formData
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('申込を受け付けました。担当者より連絡いたします。');
                        this.hideServiceModal();
                    } else {
                        throw new Error(result.error || '申込に失敗しました');
                    }

                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;

                } catch (error) {
                    console.error('申込エラー:', error);
                    alert('申込に失敗しました。しばらく時間をおいて再度お試しください。');
                    
                    const submitBtn = document.getElementById('service-next-btn');
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>申込送信';
                    submitBtn.disabled = false;
                }
            }

            updateStepIndicator(currentStep) {
                const steps = document.querySelectorAll('.step-item');
                steps.forEach((step, index) => {
                    const stepNum = index + 1;
                    const circle = step.querySelector('.step-circle');
                    const text = step.querySelector('span');
                    
                    if (stepNum <= currentStep) {
                        circle.className = 'step-circle bg-primary text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-medium';
                        text.className = 'ml-2 text-sm font-medium text-primary';
                    } else {
                        circle.className = 'step-circle bg-gray-300 text-gray-500 rounded-full w-8 h-8 flex items-center justify-center text-sm font-medium';
                        text.className = 'ml-2 text-sm font-medium text-gray-500';
                    }
                });
            }

            updateButtons() {
                const prevBtn = document.getElementById('service-prev-btn');
                const nextBtn = document.getElementById('service-next-btn');
                
                if (this.currentStep === 1) {
                    prevBtn.classList.add('hidden');
                    nextBtn.innerHTML = '次へ <i class="fas fa-chevron-right ml-2"></i>';
                } else if (this.currentStep === 2) {
                    prevBtn.classList.remove('hidden');
                    nextBtn.innerHTML = '次へ <i class="fas fa-chevron-right ml-2"></i>';
                } else if (this.currentStep === 3) {
                    prevBtn.classList.remove('hidden');
                    nextBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>申込送信';
                }
            }

            filterServices() {
                const categoryFilter = document.getElementById('service-category-filter').value;
                const urgencyFilter = document.getElementById('service-urgency-filter').value;
                const searchTerm = document.getElementById('service-search').value.toLowerCase();

                const serviceCards = document.querySelectorAll('.service-card');
                
                serviceCards.forEach(card => {
                    const category = card.dataset.category;
                    const urgency = card.dataset.urgency;
                    const title = card.querySelector('h3').textContent.toLowerCase();
                    const description = card.querySelector('p').textContent.toLowerCase();

                    let show = true;

                    if (categoryFilter && category !== categoryFilter) show = false;
                    if (urgencyFilter && urgency !== urgencyFilter) show = false;
                    if (searchTerm && !title.includes(searchTerm) && !description.includes(searchTerm)) show = false;

                    card.style.display = show ? 'block' : 'none';
                });
            }
        }

        // 請求・支払い管理クラス
        class BillingManager {
            constructor() {
                this.baseURL = 'http://localhost:3001/api';
                this.invoices = [];
                this.setupEventListeners();
                this.loadInvoices(); // 初期データ読み込み
            }

            setupEventListeners() {
                // モーダル関連
                document.getElementById('close-billing-detail-modal-btn')?.addEventListener('click', () => {
                    this.hideBillingDetailModal();
                });

                document.getElementById('close-payment-options-modal-btn')?.addEventListener('click', () => {
                    this.hidePaymentOptionsModal();
                });

                // フィルター機能
                document.getElementById('billing-period-filter')?.addEventListener('change', () => {
                    this.filterInvoices();
                });

                document.getElementById('billing-status-filter')?.addEventListener('change', () => {
                    this.filterInvoices();
                });

                document.getElementById('billing-amount-filter')?.addEventListener('change', () => {
                    this.filterInvoices();
                });

                document.getElementById('billing-service-filter')?.addEventListener('change', () => {
                    this.filterInvoices();
                });

                document.getElementById('billing-search')?.addEventListener('input', () => {
                    this.filterInvoices();
                });
            }

            // APIから請求書データを取得
            async loadInvoices() {
                try {
                    const response = await fetch(`${this.baseURL}/invoices`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.invoices = data.data;
                        this.updateInvoiceTable();
                        this.updateSummary();
                    } else {
                        console.error('請求書の取得に失敗しました:', data.error);
                        // サンプルデータを使用
                        this.loadSampleData();
                    }
                } catch (error) {
                    console.error('APIエラー:', error);
                    // サンプルデータを使用
                    this.loadSampleData();
                }
            }

            // サンプルデータ読み込み（API未実装時の代替）
            loadSampleData() {
                this.invoices = [
                    {
                        id: 1,
                        invoice_number: 'INV-2024-08-001',
                        invoice_date: '2024-08-01',
                        due_date: '2024-08-31',
                        service_type: 'monthly',
                        service_name: '月額基本料金',
                        amount: 150000,
                        tax_amount: 15000,
                        total_amount: 165000,
                        status: 'paid',
                        description: '8月分月額基本料金'
                    },
                    {
                        id: 2,
                        invoice_number: 'INV-2024-07-015',
                        invoice_date: '2024-07-25',
                        due_date: '2024-08-25',
                        service_type: 'emergency',
                        service_name: '緊急出動料金',
                        amount: 320000,
                        tax_amount: 32000,
                        total_amount: 352000,
                        status: 'pending',
                        description: 'カスハラ緊急出動対応'
                    },
                    {
                        id: 3,
                        invoice_number: 'INV-2024-07-008',
                        invoice_date: '2024-07-10',
                        due_date: '2024-08-10',
                        service_type: 'training',
                        service_name: 'セキュリティ研修',
                        amount: 80000,
                        tax_amount: 8000,
                        total_amount: 88000,
                        status: 'paid',
                        description: '全社員向けセキュリティ研修'
                    }
                ];
                this.updateInvoiceTable();
                this.updateSummary();
            }

            // 請求書テーブルの更新
            updateInvoiceTable() {
                const tbody = document.getElementById('billing-table-body');
                if (!tbody) return;

                tbody.innerHTML = '';

                this.invoices.forEach(invoice => {
                    const row = this.createInvoiceRow(invoice);
                    tbody.appendChild(row);
                });

                // モバイルカード表示も更新
                this.updateMobileBillingCards();
            }

            // 📱 モバイル用請求書カード表示更新
            updateMobileBillingCards() {
                const container = document.getElementById('billing-cards-container');
                if (!container) return;

                container.innerHTML = this.invoices.map(invoice => {
                    const statusBadge = this.getStatusBadge(invoice.status);
                    const serviceTypeBadge = this.getServiceTypeBadge(invoice.service_type);
                    const iconClass = this.getServiceIcon(invoice.service_type);
                    const isOverdue = invoice.status === 'pending' && new Date(invoice.due_date) < new Date();

                    return `
                        <div class="bg-white rounded-lg border p-4 shadow-sm ${isOverdue ? 'border-red-200' : ''}">
                            <!-- 請求書ヘッダー -->
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                        <i class="fas ${iconClass} text-blue-600"></i>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-900">${invoice.invoice_number}</div>
                                        <div class="text-sm text-gray-500">${invoice.service_name}</div>
                                    </div>
                                </div>
                                ${statusBadge}
                            </div>

                            <!-- 金額・日付情報 -->
                            <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                                <div>
                                    <div class="text-gray-500">請求金額</div>
                                    <div class="font-bold text-lg text-gray-900">¥${this.formatNumber(invoice.total_amount)}</div>
                                    <div class="text-gray-500 text-xs">（税込）</div>
                                </div>
                                <div>
                                    <div class="text-gray-500">支払期限</div>
                                    <div class="font-medium ${isOverdue ? 'text-red-600' : 'text-gray-900'}">${this.formatDate(invoice.due_date)}</div>
                                    ${isOverdue ? '<div class="text-red-500 text-xs font-medium">期限切れ</div>' : ''}
                                </div>
                            </div>

                            <!-- サービス種別 -->
                            <div class="mb-4">
                                ${serviceTypeBadge}
                            </div>

                            <!-- アクションボタン -->
                            <div class="flex justify-end space-x-2">
                                <button 
                                    onclick="showBillingDetail(${invoice.id})" 
                                    class="px-3 py-2 bg-blue-100 text-blue-700 rounded-md text-sm hover:bg-blue-200 transition-colors"
                                >
                                    <i class="fas fa-eye mr-1"></i>詳細
                                </button>
                                <button 
                                    onclick="downloadInvoicePDF(${invoice.id})" 
                                    class="px-3 py-2 bg-green-100 text-green-700 rounded-md text-sm hover:bg-green-200 transition-colors"
                                >
                                    <i class="fas fa-download mr-1"></i>PDF
                                </button>
                                ${invoice.status === 'pending' ? `
                                <button 
                                    onclick="showPaymentOptions(${invoice.id})" 
                                    class="px-3 py-2 bg-purple-100 text-purple-700 rounded-md text-sm hover:bg-purple-200 transition-colors"
                                >
                                    <i class="fas fa-credit-card mr-1"></i>支払い
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // 請求書行を作成
            createInvoiceRow(invoice) {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                const statusBadge = this.getStatusBadge(invoice.status);
                const serviceTypeBadge = this.getServiceTypeBadge(invoice.service_type);
                const iconClass = this.getServiceIcon(invoice.service_type);

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <i class="fas ${iconClass} mr-3"></i>
                            <div>
                                <div class="text-sm font-medium text-gray-900">${invoice.invoice_number}</div>
                                <div class="text-sm text-gray-500">${invoice.description}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${this.formatDate(invoice.invoice_date)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${this.formatDate(invoice.due_date)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${serviceTypeBadge}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">¥${this.formatNumber(invoice.amount)}</div>
                        <div class="text-sm text-gray-500">税込 ¥${this.formatNumber(invoice.total_amount)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${statusBadge}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button class="text-blue-600 hover:text-blue-700 focus-ring rounded" onclick="showBillingDetail(${invoice.id})">
                            <i class="fas fa-eye mr-1"></i>詳細
                        </button>
                        <button class="text-green-600 hover:text-green-700 focus-ring rounded" onclick="downloadInvoicePDF(${invoice.id})">
                            <i class="fas fa-download mr-1"></i>PDF
                        </button>
                        ${invoice.status === 'pending' ? `
                        <button class="text-purple-600 hover:text-purple-700 focus-ring rounded" onclick="showPaymentOptions(${invoice.id})">
                            <i class="fas fa-credit-card mr-1"></i>支払い
                        </button>
                        ` : ''}
                    </td>
                `;

                return row;
            }

            // ステータスバッジ
            getStatusBadge(status) {
                const badges = {
                    'paid': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"><i class="fas fa-check mr-1"></i>支払い済み</span>',
                    'pending': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"><i class="fas fa-clock mr-1"></i>支払い待ち</span>',
                    'overdue': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800"><i class="fas fa-exclamation-triangle mr-1"></i>延滞中</span>'
                };
                return badges[status] || badges['pending'];
            }

            // サービスタイプバッジ
            getServiceTypeBadge(serviceType) {
                const badges = {
                    'monthly': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">月額サービス</span>',
                    'emergency': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">緊急対応</span>',
                    'training': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">研修・教育</span>',
                    'equipment': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">機器・設備</span>'
                };
                return badges[serviceType] || badges['monthly'];
            }

            // サービスアイコン
            getServiceIcon(serviceType) {
                const icons = {
                    'monthly': 'fa-file-invoice text-blue-500',
                    'emergency': 'fa-file-invoice text-red-500',
                    'training': 'fa-file-invoice text-green-500',
                    'equipment': 'fa-file-invoice text-purple-500'
                };
                return icons[serviceType] || 'fa-file-invoice text-blue-500';
            }

            // 数値フォーマット
            formatNumber(number) {
                return new Intl.NumberFormat('ja-JP').format(number);
            }

            // 日付フォーマット
            formatDate(dateString) {
                const date = new Date(dateString);
                return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
            }

            // サマリー更新
            updateSummary() {
                const currentMonth = new Date().getMonth() + 1;
                const currentYear = new Date().getFullYear();
                
                // 今月の請求額計算
                const thisMonthInvoices = this.invoices.filter(inv => {
                    const invDate = new Date(inv.invoice_date);
                    return invDate.getMonth() + 1 === currentMonth && invDate.getFullYear() === currentYear;
                });
                
                const thisMonthTotal = thisMonthInvoices.reduce((sum, inv) => sum + inv.total_amount, 0);
                const paidTotal = this.invoices.filter(inv => inv.status === 'paid').reduce((sum, inv) => sum + inv.total_amount, 0);
                const pendingTotal = this.invoices.filter(inv => inv.status === 'pending').reduce((sum, inv) => sum + inv.total_amount, 0);
                const overdueTotal = this.invoices.filter(inv => inv.status === 'overdue').reduce((sum, inv) => sum + inv.total_amount, 0);

                // サマリーカードを更新（実装予定）
                console.log('サマリー更新:', { thisMonthTotal, paidTotal, pendingTotal, overdueTotal });
            }

            // 請求書詳細表示
            showBillingDetail(invoiceId) {
                const invoice = this.invoices.find(inv => inv.id === invoiceId);
                if (!invoice) return;

                const modal = document.getElementById('billing-detail-modal');
                const content = document.getElementById('billing-detail-content');
                
                content.innerHTML = `
                    <div class="space-y-6">
                        <!-- 請求書ヘッダー -->
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="font-medium text-gray-900 mb-3">請求書情報</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">請求書番号:</span>
                                            <span class="font-medium">${invoice.invoice_number}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">請求日:</span>
                                            <span>${this.formatDate(invoice.invoice_date)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">支払期限:</span>
                                            <span>${this.formatDate(invoice.due_date)}</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-900 mb-3">金額詳細</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">小計:</span>
                                            <span>¥${this.formatNumber(invoice.amount)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">消費税:</span>
                                            <span>¥${this.formatNumber(invoice.tax_amount)}</span>
                                        </div>
                                        <div class="flex justify-between border-t pt-2 font-medium">
                                            <span class="text-gray-900">合計:</span>
                                            <span class="text-lg">¥${this.formatNumber(invoice.total_amount)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- サービス詳細 -->
                        <div>
                            <h4 class="font-medium text-gray-900 mb-3">サービス内容</h4>
                            <div class="bg-white border rounded-lg p-4">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h5 class="font-medium text-gray-900">${invoice.service_name}</h5>
                                        <p class="text-gray-600 text-sm">${invoice.description}</p>
                                        <div class="mt-2">
                                            ${this.getServiceTypeBadge(invoice.service_type)}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-medium">¥${this.formatNumber(invoice.total_amount)}</div>
                                        <div class="text-sm text-gray-500">税込</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- アクションボタン -->
                        <div class="flex justify-end space-x-4 pt-6 border-t">
                            <button onclick="downloadInvoicePDF(${invoice.id})" class="px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors focus-ring">
                                <i class="fas fa-download mr-2"></i>PDF ダウンロード
                            </button>
                            ${invoice.status === 'pending' ? `
                            <button onclick="window.billingManager.hideBillingDetailModal(); showPaymentOptions(${invoice.id})" class="px-6 py-3 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors focus-ring">
                                <i class="fas fa-credit-card mr-2"></i>支払い手続き
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `;

                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            hideBillingDetailModal() {
                document.getElementById('billing-detail-modal').classList.add('hidden');
                document.body.style.overflow = 'auto';
            }

            showPaymentOptions(invoiceId) {
                const modal = document.getElementById('payment-options-modal');
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            hidePaymentOptionsModal() {
                document.getElementById('payment-options-modal').classList.add('hidden');
                document.body.style.overflow = 'auto';
            }

            // フィルター機能
            filterInvoices() {
                const periodFilter = document.getElementById('billing-period-filter').value;
                const statusFilter = document.getElementById('billing-status-filter').value;
                const amountFilter = document.getElementById('billing-amount-filter').value;
                const serviceFilter = document.getElementById('billing-service-filter').value;
                const searchTerm = document.getElementById('billing-search').value.toLowerCase();

                console.log('フィルター適用:', { periodFilter, statusFilter, amountFilter, serviceFilter, searchTerm });
                // 実際のフィルター処理をここに実装
            }

            // PDF ダウンロード
            downloadInvoicePDF(invoiceId) {
                const invoice = this.invoices.find(inv => inv.id === invoiceId);
                if (!invoice) return;

                // 実際の実装ではAPIを呼び出し
                alert(`${invoice.invoice_number} のPDFダウンロードを開始します（実装予定）`);
            }
        }

        // ====================
        // ユーザー管理クラス
        // ====================
        class UserManager {
            constructor() {
                this.users = [];
                this.filteredUsers = [];
                this.currentPage = 1;
                this.usersPerPage = 10;
                this.baseURL = 'http://localhost:3001/api';
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadUsers();
            }

            setupEventListeners() {
                // 検索・フィルターイベント
                document.getElementById('user-search')?.addEventListener('input', () => {
                    this.filterUsers();
                });

                document.getElementById('role-filter')?.addEventListener('change', () => {
                    this.filterUsers();
                });

                document.getElementById('status-filter')?.addEventListener('change', () => {
                    this.filterUsers();
                });

                // ボタンイベント
                document.getElementById('refresh-users-btn')?.addEventListener('click', () => {
                    this.loadUsers();
                });

                document.getElementById('add-user-btn')?.addEventListener('click', () => {
                    this.showAddUserModal();
                });

                // ページネーション
                document.getElementById('users-prev-page')?.addEventListener('click', () => {
                    if (this.currentPage > 1) {
                        this.currentPage--;
                        this.updateUserTable();
                    }
                });

                document.getElementById('users-next-page')?.addEventListener('click', () => {
                    const totalPages = Math.ceil(this.filteredUsers.length / this.usersPerPage);
                    if (this.currentPage < totalPages) {
                        this.currentPage++;
                        this.updateUserTable();
                    }
                });

                // モーダルイベント
                document.getElementById('save-user-btn')?.addEventListener('click', () => {
                    this.saveUser();
                });

                document.getElementById('cancel-edit-btn')?.addEventListener('click', () => {
                    this.hideEditModal();
                });
            }

            // APIからユーザーデータを取得
            async loadUsers() {
                try {
                    // 実際のAPIエンドポイントが実装されるまでサンプルデータを使用
                    this.loadSampleUsers();
                } catch (error) {
                    console.error('APIエラー:', error);
                    this.loadSampleUsers();
                }
            }

            // サンプルユーザーデータ（API実装前）
            loadSampleUsers() {
                this.users = [
                    {
                        id: 1,
                        name: '田中太郎',
                        email: 'tanaka@company.com',
                        role: 'ClientAdmin',
                        status: 'active',
                        last_login: '2024-08-28 10:30:00',
                        created_at: '2024-06-01 09:00:00',
                        login_count: 45
                    },
                    {
                        id: 2,
                        name: '佐藤花子',
                        email: 'sato@company.com',
                        role: 'ClientUser',
                        status: 'active',
                        last_login: '2024-08-27 16:45:00',
                        created_at: '2024-06-15 14:20:00',
                        login_count: 23
                    },
                    {
                        id: 3,
                        name: '鈴木一郎',
                        email: 'suzuki@company.com',
                        role: 'ClientUser',
                        status: 'active',
                        last_login: '2024-08-26 11:20:00',
                        created_at: '2024-07-01 10:30:00',
                        login_count: 12
                    },
                    {
                        id: 4,
                        name: '高橋美和',
                        email: 'takahashi@company.com',
                        role: 'ClientUser',
                        status: 'inactive',
                        last_login: '2024-07-20 09:15:00',
                        created_at: '2024-05-15 13:45:00',
                        login_count: 8
                    }
                ];

                this.filteredUsers = [...this.users];
                this.updateUserTable();
                this.loadActivityLog();
            }

            // ユーザーフィルター
            filterUsers() {
                const searchTerm = document.getElementById('user-search').value.toLowerCase();
                const roleFilter = document.getElementById('role-filter').value;
                const statusFilter = document.getElementById('status-filter').value;

                this.filteredUsers = this.users.filter(user => {
                    const matchesSearch = user.name.toLowerCase().includes(searchTerm) || 
                                         user.email.toLowerCase().includes(searchTerm);
                    const matchesRole = !roleFilter || user.role === roleFilter;
                    const matchesStatus = !statusFilter || user.status === statusFilter;

                    return matchesSearch && matchesRole && matchesStatus;
                });

                this.currentPage = 1;
                this.updateUserTable();
            }

            // ユーザーテーブル更新
            updateUserTable() {
                const tbody = document.getElementById('users-table-body');
                const startIndex = (this.currentPage - 1) * this.usersPerPage;
                const endIndex = startIndex + this.usersPerPage;
                const pageUsers = this.filteredUsers.slice(startIndex, endIndex);

                tbody.innerHTML = pageUsers.map(user => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <div class="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center">
                                        <i class="fas fa-user text-gray-500"></i>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${user.name}</div>
                                    <div class="text-sm text-gray-500">${user.email}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${this.getRoleBadge(user.role)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${this.getStatusBadge(user.status)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${this.formatDateTime(user.last_login)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <button 
                                onclick="userManager.editUser(${user.id})" 
                                class="text-blue-600 hover:text-blue-900 focus-ring rounded"
                            >
                                <i class="fas fa-edit mr-1"></i>編集
                            </button>
                            <button 
                                onclick="userManager.viewUserActivity(${user.id})" 
                                class="text-green-600 hover:text-green-900 focus-ring rounded"
                            >
                                <i class="fas fa-history mr-1"></i>履歴
                            </button>
                            ${user.status === 'active' ? 
                                `<button onclick="userManager.toggleUserStatus(${user.id})" class="text-yellow-600 hover:text-yellow-900 focus-ring rounded">
                                    <i class="fas fa-pause mr-1"></i>無効化
                                </button>` : 
                                `<button onclick="userManager.toggleUserStatus(${user.id})" class="text-green-600 hover:text-green-900 focus-ring rounded">
                                    <i class="fas fa-play mr-1"></i>有効化
                                </button>`
                            }
                        </td>
                    </tr>
                `).join('');

                // ユーザー数とページネーション情報を更新
                document.getElementById('users-count').textContent = `(${this.filteredUsers.length}名)`;
                
                const totalPages = Math.ceil(this.filteredUsers.length / this.usersPerPage);
                const showingStart = startIndex + 1;
                const showingEnd = Math.min(endIndex, this.filteredUsers.length);
                
                document.getElementById('users-pagination-info').textContent = 
                    `${showingStart}-${showingEnd} of ${this.filteredUsers.length} users`;
                
                // ページネーションボタンの状態
                document.getElementById('users-prev-page').disabled = this.currentPage === 1;
                document.getElementById('users-next-page').disabled = this.currentPage === totalPages;
                
                // モバイルカード表示も更新
                this.updateMobileCards(pageUsers);
            }

            // 📱 モバイル用カード表示更新
            updateMobileCards(users) {
                const container = document.getElementById('users-cards-container');
                if (!container) return;

                container.innerHTML = users.map(user => `
                    <div class="bg-white rounded-lg border p-4 shadow-sm">
                        <!-- ユーザー基本情報 -->
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-gray-500"></i>
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-900">${user.name}</div>
                                    <div class="text-sm text-gray-500">${user.email}</div>
                                </div>
                            </div>
                            ${this.getStatusBadge(user.status)}
                        </div>

                        <!-- 権限・情報 -->
                        <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                            <div>
                                <div class="text-gray-500">権限レベル</div>
                                <div class="mt-1">${this.getRoleBadge(user.role)}</div>
                            </div>
                            <div>
                                <div class="text-gray-500">最終ログイン</div>
                                <div class="mt-1 font-medium">${this.formatDateTime(user.last_login)}</div>
                            </div>
                        </div>

                        <!-- アクションボタン -->
                        <div class="flex justify-end space-x-2">
                            <button 
                                onclick="userManager.editUser(${user.id})" 
                                class="px-3 py-2 bg-blue-100 text-blue-700 rounded-md text-sm hover:bg-blue-200 transition-colors"
                            >
                                <i class="fas fa-edit mr-1"></i>編集
                            </button>
                            <button 
                                onclick="userManager.viewUserActivity(${user.id})" 
                                class="px-3 py-2 bg-green-100 text-green-700 rounded-md text-sm hover:bg-green-200 transition-colors"
                            >
                                <i class="fas fa-history mr-1"></i>履歴
                            </button>
                            <button 
                                onclick="userManager.toggleUserStatus(${user.id})" 
                                class="px-3 py-2 ${user.status === 'active' ? 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200' : 'bg-green-100 text-green-700 hover:bg-green-200'} rounded-md text-sm transition-colors"
                            >
                                <i class="fas fa-${user.status === 'active' ? 'pause' : 'play'} mr-1"></i>
                                ${user.status === 'active' ? '無効化' : '有効化'}
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            // 権限レベルバッジ
            getRoleBadge(role) {
                const badges = {
                    'ClientAdmin': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800"><i class="fas fa-crown mr-1"></i>管理者</span>',
                    'ClientUser': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"><i class="fas fa-user mr-1"></i>一般ユーザー</span>'
                };
                return badges[role] || '<span class="text-gray-500">未設定</span>';
            }

            // ステータスバッジ
            getStatusBadge(status) {
                const badges = {
                    'active': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"><i class="fas fa-check-circle mr-1"></i>アクティブ</span>',
                    'inactive': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800"><i class="fas fa-pause-circle mr-1"></i>無効</span>'
                };
                return badges[status] || '<span class="text-gray-500">不明</span>';
            }

            // ユーザー編集モーダル表示
            editUser(userId) {
                const user = this.users.find(u => u.id === userId);
                if (!user) return;

                document.getElementById('modal-title').textContent = 'ユーザー編集';
                document.getElementById('edit-user-id').value = user.id;
                document.getElementById('edit-user-name').value = user.name;
                document.getElementById('edit-user-email').value = user.email;
                document.getElementById('edit-user-role').value = user.role;
                document.getElementById('edit-user-status').value = user.status;

                document.getElementById('user-edit-modal').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            // 新規ユーザー追加モーダル表示
            showAddUserModal() {
                document.getElementById('modal-title').textContent = '新規ユーザー追加';
                document.getElementById('user-edit-form').reset();
                document.getElementById('edit-user-id').value = '';

                document.getElementById('user-edit-modal').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            // モーダルを非表示
            hideEditModal() {
                document.getElementById('user-edit-modal').classList.add('hidden');
                document.body.style.overflow = 'auto';
            }

            // ユーザー保存
            async saveUser() {
                const formData = new FormData(document.getElementById('user-edit-form'));
                const userId = formData.get('userId');
                
                const userData = {
                    name: formData.get('userName'),
                    email: formData.get('userEmail'),
                    role: formData.get('userRole'),
                    status: formData.get('userStatus')
                };

                try {
                    // 実際のAPI呼び出しはここに実装
                    if (userId) {
                        // 更新
                        const userIndex = this.users.findIndex(u => u.id == userId);
                        if (userIndex !== -1) {
                            this.users[userIndex] = { ...this.users[userIndex], ...userData };
                        }
                        alert('ユーザー情報が更新されました');
                    } else {
                        // 新規追加
                        const newUser = {
                            id: Math.max(...this.users.map(u => u.id)) + 1,
                            ...userData,
                            last_login: null,
                            created_at: new Date().toISOString(),
                            login_count: 0
                        };
                        this.users.push(newUser);
                        alert('新しいユーザーが追加されました');
                    }

                    this.filterUsers();
                    this.hideEditModal();

                } catch (error) {
                    console.error('ユーザー保存エラー:', error);
                    alert('ユーザー情報の保存に失敗しました');
                }
            }

            // ユーザーステータス切り替え
            toggleUserStatus(userId) {
                const user = this.users.find(u => u.id === userId);
                if (!user) return;

                const newStatus = user.status === 'active' ? 'inactive' : 'active';
                const action = newStatus === 'active' ? '有効化' : '無効化';

                if (confirm(`${user.name} を${action}しますか？`)) {
                    user.status = newStatus;
                    this.updateUserTable();
                    alert(`${user.name} が${action}されました`);
                }
            }

            // ユーザーアクティビティ表示
            viewUserActivity(userId) {
                const user = this.users.find(u => u.id === userId);
                if (!user) return;

                alert(`${user.name} のアクティビティ:\n・ログイン回数: ${user.login_count}回\n・最終ログイン: ${this.formatDateTime(user.last_login)}\n・作成日: ${this.formatDateTime(user.created_at)}`);
            }

            // アクティビティログ読み込み
            loadActivityLog() {
                const activityLog = document.getElementById('activity-log');
                
                // サンプルアクティビティデータ
                const activities = [
                    {
                        user: '田中太郎',
                        action: 'ログイン',
                        timestamp: '2024-08-28 10:30:00',
                        details: 'IPアドレス: 192.168.1.100'
                    },
                    {
                        user: '佐藤花子',
                        action: '請求書確認',
                        timestamp: '2024-08-27 16:45:00',
                        details: '請求書 INV-2024-08-001 を閲覧'
                    },
                    {
                        user: '鈴木一郎',
                        action: 'サービス申請',
                        timestamp: '2024-08-26 14:20:00',
                        details: 'セキュリティ研修を申請'
                    },
                    {
                        user: '田中太郎',
                        action: 'ユーザー編集',
                        timestamp: '2024-08-26 11:15:00',
                        details: '佐藤花子 の権限を変更'
                    }
                ];

                activityLog.innerHTML = activities.map(activity => `
                    <div class="flex items-start space-x-4 p-3 bg-gray-50 rounded-lg">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-history text-blue-600 text-sm"></i>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2">
                                <span class="font-medium text-gray-900">${activity.user}</span>
                                <span class="text-gray-500">•</span>
                                <span class="text-gray-600">${activity.action}</span>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">${activity.details}</p>
                        </div>
                        <div class="flex-shrink-0 text-xs text-gray-400">
                            ${this.formatDateTime(activity.timestamp)}
                        </div>
                    </div>
                `).join('');
            }

            // 日時フォーマット
            formatDateTime(dateString) {
                if (!dateString) return '未ログイン';
                
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                if (diffDays === 0) {
                    return '今日 ' + date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                } else if (diffDays === 1) {
                    return '昨日 ' + date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                } else if (diffDays < 7) {
                    return `${diffDays}日前`;
                } else {
                    return date.toLocaleDateString('ja-JP');
                }
            }
        }

        // グローバル関数
        function openServiceApplication(serviceType) {
            if (window.servicesManager) {
                window.servicesManager.openServiceApplication(serviceType);
            }
        }

        function showBillingDetail(invoiceId) {
            if (window.billingManager) {
                window.billingManager.showBillingDetail(invoiceId);
            }
        }

        // ====================
        // 🔔 通知システムクラス
        // ====================
        class NotificationManager {
            constructor() {
                this.notifications = [];
                this.unreadCount = 0;
                this.settings = {
                    payment: true,
                    urgent: true,
                    general: true,
                    paymentReminders: {
                        days14: true,
                        days7: true,
                        days3: true,
                        sameDay: true,
                        overdue: true
                    },
                    browserNotifications: true,
                    emailNotifications: false
                };
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadNotifications();
                this.setupBrowserNotifications();
                this.startPaymentReminders();
                
                console.log('通知システム初期化完了');
            }

            setupEventListeners() {
                // 通知パネルの開閉
                document.getElementById('notification-toggle')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleNotificationPanel();
                });

                // パネル外クリックで閉じる
                document.addEventListener('click', (e) => {
                    const panel = document.getElementById('notification-panel');
                    const toggle = document.getElementById('notification-toggle');
                    
                    if (panel && !panel.contains(e.target) && !toggle.contains(e.target)) {
                        panel.classList.add('hidden');
                    }
                });

                // 全て既読
                document.getElementById('mark-all-read')?.addEventListener('click', () => {
                    this.markAllAsRead();
                });

                // 通知設定
                document.getElementById('notification-settings')?.addEventListener('click', () => {
                    this.showSettingsModal();
                });

                // 設定モーダル
                document.getElementById('cancel-notification-settings')?.addEventListener('click', () => {
                    this.hideSettingsModal();
                });

                document.getElementById('save-notification-settings')?.addEventListener('click', () => {
                    this.saveSettings();
                });
            }

            // ブラウザ通知の許可取得
            async setupBrowserNotifications() {
                if ('Notification' in window && Notification.permission === 'default') {
                    const permission = await Notification.requestPermission();
                    console.log('Browser notification permission:', permission);
                }
            }

            // 通知データ読み込み
            loadNotifications() {
                // サンプル通知データ
                this.notifications = [
                    {
                        id: 1,
                        type: 'payment',
                        title: '支払期限のお知らせ',
                        message: '請求書 INV-2024-07-015 の支払期限が明日です（¥352,000）',
                        timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2時間前
                        read: false,
                        priority: 'high',
                        actionUrl: '/c/billing',
                        icon: 'fas fa-credit-card',
                        color: 'text-red-600'
                    },
                    {
                        id: 2,
                        type: 'urgent',
                        title: 'セキュリティ更新',
                        message: 'システムのセキュリティ更新が完了しました。新機能をご確認ください。',
                        timestamp: new Date(Date.now() - 4 * 60 * 60 * 1000), // 4時間前
                        read: false,
                        priority: 'medium',
                        actionUrl: '/c/announcements',
                        icon: 'fas fa-shield-alt',
                        color: 'text-blue-600'
                    },
                    {
                        id: 3,
                        type: 'general',
                        title: '新しいセミナーが追加されました',
                        message: '「リスク管理の基礎」セミナーの受付を開始しました。',
                        timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000), // 1日前
                        read: false,
                        priority: 'low',
                        actionUrl: '/c/seminars',
                        icon: 'fas fa-calendar-alt',
                        color: 'text-green-600'
                    }
                ];

                this.updateNotificationCount();
                this.updateNotificationPanel();
            }

            // 通知パネル開閉
            toggleNotificationPanel() {
                const panel = document.getElementById('notification-panel');
                if (panel) {
                    panel.classList.toggle('hidden');
                    
                    if (!panel.classList.contains('hidden')) {
                        this.updateNotificationPanel();
                    }
                }
            }

            // 通知パネル更新
            updateNotificationPanel() {
                const list = document.getElementById('notification-list');
                if (!list) return;

                if (this.notifications.length === 0) {
                    list.innerHTML = `
                        <div class="p-8 text-center text-gray-500">
                            <i class="fas fa-bell-slash text-4xl mb-4 opacity-50"></i>
                            <p>新しい通知はありません</p>
                        </div>
                    `;
                    return;
                }

                list.innerHTML = this.notifications.map(notification => `
                    <div class="p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer ${!notification.read ? 'bg-blue-50' : ''}" 
                         onclick="notificationManager.handleNotificationClick(${notification.id})">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center">
                                    <i class="${notification.icon} ${notification.color}"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between mb-1">
                                    <h4 class="text-sm font-medium text-gray-900 truncate">
                                        ${notification.title}
                                        ${!notification.read ? '<span class="ml-2 w-2 h-2 bg-blue-600 rounded-full inline-block"></span>' : ''}
                                    </h4>
                                    <span class="text-xs text-gray-500">${this.formatNotificationTime(notification.timestamp)}</span>
                                </div>
                                <p class="text-sm text-gray-600 line-clamp-2">${notification.message}</p>
                                ${notification.priority === 'high' ? '<span class="inline-block mt-1 px-2 py-1 text-xs bg-red-100 text-red-700 rounded-full">緊急</span>' : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // 通知数更新
            updateNotificationCount() {
                const unreadNotifications = this.notifications.filter(n => !n.read);
                this.unreadCount = unreadNotifications.length;
                
                const countElement = document.getElementById('notification-count');
                if (countElement) {
                    if (this.unreadCount > 0) {
                        countElement.textContent = this.unreadCount;
                        countElement.classList.remove('hidden');
                    } else {
                        countElement.classList.add('hidden');
                    }
                }
            }

            // 全て既読にする
            markAllAsRead() {
                this.notifications.forEach(notification => {
                    notification.read = true;
                });
                
                this.updateNotificationCount();
                this.updateNotificationPanel();
                
                this.showToast('すべての通知を既読にしました', 'success');
            }

            // 通知クリック処理
            handleNotificationClick(notificationId) {
                const notification = this.notifications.find(n => n.id === notificationId);
                if (!notification) return;

                // 未読を既読にする
                if (!notification.read) {
                    notification.read = true;
                    this.updateNotificationCount();
                    this.updateNotificationPanel();
                }

                // アクションURLがある場合はページ移動
                if (notification.actionUrl && window.clientPortal) {
                    const page = notification.actionUrl.split('/').pop();
                    window.clientPortal.showPage(page);
                }

                // パネルを閉じる
                document.getElementById('notification-panel')?.classList.add('hidden');
            }

            // 新しい通知を追加
            addNotification(type, title, message, priority = 'medium', actionUrl = null) {
                const notification = {
                    id: Date.now(),
                    type,
                    title,
                    message,
                    timestamp: new Date(),
                    read: false,
                    priority,
                    actionUrl,
                    icon: this.getTypeIcon(type),
                    color: this.getTypeColor(type)
                };

                this.notifications.unshift(notification);
                
                // 最大50件まで保持
                if (this.notifications.length > 50) {
                    this.notifications = this.notifications.slice(0, 50);
                }

                this.updateNotificationCount();
                this.updateNotificationPanel();

                // ブラウザ通知
                if (this.settings.browserNotifications && 'Notification' in window && Notification.permission === 'granted') {
                    new Notification(title, {
                        body: message,
                        icon: '/favicon.ico', // アイコンパスは実際のものに変更
                        tag: notification.id.toString()
                    });
                }

                // 高優先度の場合はトースト表示
                if (priority === 'high') {
                    this.showToast(title, 'warning');
                }
            }

            // 支払期限チェック・通知
            startPaymentReminders() {
                // 実際の実装では定期的にチェック
                this.checkPaymentDueDates();
                
                // 1時間ごとにチェック
                setInterval(() => {
                    this.checkPaymentDueDates();
                }, 60 * 60 * 1000);
            }

            checkPaymentDueDates() {
                if (!window.billingManager) return;

                const invoices = window.billingManager.invoices || [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                invoices.filter(invoice => invoice.status === 'pending').forEach(invoice => {
                    const dueDate = new Date(invoice.due_date);
                    dueDate.setHours(0, 0, 0, 0);
                    
                    const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

                    // 通知タイミングのチェック
                    if (this.settings.paymentReminders.days14 && daysDiff === 14) {
                        this.addNotification('payment', '支払期限まで14日', 
                            `請求書 ${invoice.invoice_number} の支払期限まで14日です（¥${this.formatNumber(invoice.total_amount)}）`, 
                            'medium', '/c/billing');
                    } else if (this.settings.paymentReminders.days7 && daysDiff === 7) {
                        this.addNotification('payment', '支払期限まで7日', 
                            `請求書 ${invoice.invoice_number} の支払期限まで1週間です（¥${this.formatNumber(invoice.total_amount)}）`, 
                            'medium', '/c/billing');
                    } else if (this.settings.paymentReminders.days3 && daysDiff === 3) {
                        this.addNotification('payment', '支払期限まで3日', 
                            `請求書 ${invoice.invoice_number} の支払期限まで3日です（¥${this.formatNumber(invoice.total_amount)}）`, 
                            'high', '/c/billing');
                    } else if (this.settings.paymentReminders.sameDay && daysDiff === 0) {
                        this.addNotification('payment', '支払期限当日', 
                            `請求書 ${invoice.invoice_number} の支払期限は今日です（¥${this.formatNumber(invoice.total_amount)}）`, 
                            'high', '/c/billing');
                    } else if (this.settings.paymentReminders.overdue && daysDiff < 0) {
                        this.addNotification('payment', '支払期限超過', 
                            `請求書 ${invoice.invoice_number} の支払期限が${Math.abs(daysDiff)}日超過しています（¥${this.formatNumber(invoice.total_amount)}）`, 
                            'high', '/c/billing');
                    }
                });
            }

            // トースト通知表示
            showToast(message, type = 'info') {
                const container = document.getElementById('notification-toast-container');
                if (!container) return;

                const toastId = 'toast-' + Date.now();
                const colors = {
                    success: 'bg-green-500',
                    warning: 'bg-yellow-500',
                    error: 'bg-red-500',
                    info: 'bg-blue-500'
                };

                const toast = document.createElement('div');
                toast.id = toastId;
                toast.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 flex items-center space-x-3`;
                toast.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'warning' ? 'exclamation-triangle' : type === 'error' ? 'times' : 'info'}-circle"></i>
                    <span class="flex-1">${message}</span>
                    <button onclick="document.getElementById('${toastId}').remove()" class="text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                container.appendChild(toast);

                // アニメーション
                setTimeout(() => toast.classList.remove('translate-x-full'), 100);

                // 自動削除
                setTimeout(() => {
                    toast.classList.add('translate-x-full');
                    setTimeout(() => toast.remove(), 300);
                }, 5000);
            }

            // 設定モーダル表示/非表示
            showSettingsModal() {
                document.getElementById('notification-settings-modal')?.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            hideSettingsModal() {
                document.getElementById('notification-settings-modal')?.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }

            saveSettings() {
                // 実際の設定保存処理をここに実装
                this.hideSettingsModal();
                this.showToast('通知設定を保存しました', 'success');
            }

            // ユーティリティメソッド
            getTypeIcon(type) {
                const icons = {
                    payment: 'fas fa-credit-card',
                    urgent: 'fas fa-exclamation-triangle',
                    general: 'fas fa-info-circle',
                    security: 'fas fa-shield-alt',
                    system: 'fas fa-cog'
                };
                return icons[type] || 'fas fa-bell';
            }

            getTypeColor(type) {
                const colors = {
                    payment: 'text-blue-600',
                    urgent: 'text-red-600',
                    general: 'text-green-600',
                    security: 'text-yellow-600',
                    system: 'text-gray-600'
                };
                return colors[type] || 'text-gray-600';
            }

            formatNotificationTime(timestamp) {
                const now = new Date();
                const diff = now - timestamp;
                const minutes = Math.floor(diff / (1000 * 60));
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);

                if (minutes < 1) return '今';
                if (minutes < 60) return `${minutes}分前`;
                if (hours < 24) return `${hours}時間前`;
                if (days < 7) return `${days}日前`;
                return timestamp.toLocaleDateString('ja-JP');
            }

            formatNumber(number) {
                return new Intl.NumberFormat('ja-JP').format(number);
            }
        }

        // ====================
        // 📊 レポート管理クラス
        // ====================
        class ReportManager {
            constructor() {
                this.reports = [];
                this.charts = {};
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadReportData();
                this.initializeCharts();
                this.loadReportsHistory();
                
                console.log('レポート機能初期化完了');
            }

            setupEventListeners() {
                document.getElementById('generate-custom-report-btn')?.addEventListener('click', () => {
                    this.showCustomReportDialog();
                });
            }

            // レポートデータ読み込み
            loadReportData() {
                // 実際の実装では billingManager などからデータを取得
                this.reportData = {
                    monthly: {
                        labels: ['4月', '5月', '6月', '7月', '8月'],
                        invoiceAmounts: [180000, 220000, 195000, 352000, 165000],
                        serviceUsage: [3, 4, 2, 6, 2]
                    },
                    services: {
                        labels: ['月額基本料', '緊急出動', 'セキュリティ研修', '防犯カメラ', '法的書類'],
                        amounts: [165000, 352000, 88000, 495000, 120000],
                        colors: ['#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6']
                    },
                    kpis: {
                        totalPayment: 2340000,
                        serviceCount: 24,
                        responseTime: 2.4,
                        satisfaction: 4.8
                    }
                };
            }

            // チャート初期化
            initializeCharts() {
                this.initMonthlyChart();
                this.initServicePieChart();
            }

            // 月次推移グラフ
            initMonthlyChart() {
                const ctx = document.getElementById('monthly-chart');
                if (!ctx) return;

                this.charts.monthly = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: this.reportData.monthly.labels,
                        datasets: [{
                            label: '請求額（円）',
                            data: this.reportData.monthly.invoiceAmounts,
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#3B82F6',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#ffffff',
                                bodyColor: '#ffffff',
                                callbacks: {
                                    label: function(context) {
                                        return `請求額: ¥${context.parsed.y.toLocaleString()}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return `¥${(value / 1000)}k`;
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            }

            // サービス利用割合円グラフ
            initServicePieChart() {
                const ctx = document.getElementById('service-pie-chart');
                if (!ctx) return;

                this.charts.servicePie = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: this.reportData.services.labels,
                        datasets: [{
                            data: this.reportData.services.amounts,
                            backgroundColor: this.reportData.services.colors,
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#ffffff',
                                bodyColor: '#ffffff',
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return `${context.label}: ¥${context.parsed.toLocaleString()} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        cutout: '60%'
                    }
                });
            }

            // レポート生成
            async generateReport(type) {
                // ローディング状態表示
                if (window.notificationManager) {
                    window.notificationManager.showToast('レポートを生成しています...', 'info');
                }

                // 実際のレポート生成処理をシミュレート
                setTimeout(() => {
                    const report = this.createReportData(type);
                    this.downloadReport(report);
                    
                    if (window.notificationManager) {
                        window.notificationManager.showToast('レポートが生成されました', 'success');
                    }

                    // 履歴に追加
                    this.addToReportsHistory(report);
                }, 2000);
            }

            // レポートデータ作成
            createReportData(type) {
                const now = new Date();
                const reportTypes = {
                    monthly: {
                        name: '月次レポート',
                        period: `${now.getFullYear()}年${now.getMonth() + 1}月`,
                        type: '月次'
                    },
                    yearly: {
                        name: '年次レポート', 
                        period: `${now.getFullYear()}年`,
                        type: '年次'
                    },
                    cost: {
                        name: 'コスト分析レポート',
                        period: `${now.getFullYear()}年${now.getMonth() + 1}月`,
                        type: 'コスト分析'
                    },
                    performance: {
                        name: 'パフォーマンスレポート',
                        period: `${now.getFullYear()}年Q${Math.ceil((now.getMonth() + 1) / 3)}`,
                        type: 'パフォーマンス'
                    }
                };

                const reportInfo = reportTypes[type] || reportTypes.monthly;

                return {
                    id: Date.now(),
                    ...reportInfo,
                    createdAt: now,
                    data: this.generateReportContent(type)
                };
            }

            // レポート内容生成
            generateReportContent(type) {
                switch (type) {
                    case 'monthly':
                        return {
                            totalInvoices: 3,
                            totalAmount: 517000,
                            paidAmount: 253000,
                            pendingAmount: 264000,
                            serviceBreakdown: this.reportData.services,
                            summary: '今月は緊急出動が1件発生し、通常より請求額が増加しています。'
                        };
                    case 'yearly':
                        return {
                            totalInvoices: 28,
                            totalAmount: 2340000,
                            averageMonthly: 195000,
                            serviceGrowth: '+15%',
                            costReduction: '-8%',
                            summary: '年間を通じて安定したサービス利用があり、コスト効率も改善しています。'
                        };
                    case 'cost':
                        return {
                            serviceEfficiency: {
                                'カスハラ対応': '¥88,000/件',
                                'セキュリティ研修': '¥22,000/人',
                                '防犯カメラ': '¥165,000/システム'
                            },
                            roi: '+245%',
                            costSavings: '¥480,000/年',
                            summary: 'セキュリティ投資により事故関連コストを大幅に削減できています。'
                        };
                    case 'performance':
                        return {
                            responseTime: '2.4時間',
                            resolutionRate: '98.5%',
                            customerSatisfaction: '4.8/5.0',
                            incidentPrevention: '+67%',
                            summary: '高いサービス品質を維持し、予防効果も向上しています。'
                        };
                    default:
                        return {};
                }
            }

            // レポートダウンロード（簡易版）
            downloadReport(report) {
                const content = this.formatReportForDownload(report);
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${report.name}_${report.period}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // レポート内容フォーマット
            formatReportForDownload(report) {
                let content = `スマートポリス ${report.name}\n`;
                content += `対象期間: ${report.period}\n`;
                content += `作成日: ${report.createdAt.toLocaleDateString('ja-JP')}\n`;
                content += `\n${'='.repeat(50)}\n\n`;

                // データ内容を整形
                if (report.data) {
                    Object.entries(report.data).forEach(([key, value]) => {
                        if (typeof value === 'object') {
                            content += `${key}:\n`;
                            Object.entries(value).forEach(([subKey, subValue]) => {
                                content += `  - ${subKey}: ${subValue}\n`;
                            });
                        } else {
                            content += `${key}: ${value}\n`;
                        }
                    });
                }

                content += `\n${'='.repeat(50)}\n`;
                content += `\nこのレポートはスマートポリス管理システムで自動生成されました。\n`;
                content += `詳細な分析や追加データが必要な場合は、カスタムレポート機能をご利用ください。\n`;

                return content;
            }

            // レポート履歴読み込み
            loadReportsHistory() {
                // サンプルデータ
                const sampleReports = [
                    {
                        id: 1,
                        name: '月次レポート',
                        type: '月次',
                        period: '2024年7月',
                        createdAt: new Date('2024-08-01')
                    },
                    {
                        id: 2,
                        name: 'コスト分析レポート',
                        type: 'コスト分析', 
                        period: '2024年Q2',
                        createdAt: new Date('2024-07-15')
                    },
                    {
                        id: 3,
                        name: '年次レポート',
                        type: '年次',
                        period: '2023年',
                        createdAt: new Date('2024-01-31')
                    }
                ];

                this.reports = sampleReports;
                this.updateReportsTable();
            }

            // レポート履歴テーブル更新
            updateReportsTable() {
                const tbody = document.getElementById('reports-table-body');
                if (!tbody) return;

                tbody.innerHTML = this.reports.map(report => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <i class="fas fa-file-alt text-blue-500 mr-3"></i>
                                <div>
                                    <div class="text-sm font-medium text-gray-900">${report.name}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                ${report.type}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${report.period}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${report.createdAt.toLocaleDateString('ja-JP')}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <button onclick="reportManager.downloadExistingReport(${report.id})" class="text-blue-600 hover:text-blue-900 focus-ring rounded">
                                <i class="fas fa-download mr-1"></i>ダウンロード
                            </button>
                            <button onclick="reportManager.deleteReport(${report.id})" class="text-red-600 hover:text-red-900 focus-ring rounded">
                                <i class="fas fa-trash mr-1"></i>削除
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            // 既存レポート再ダウンロード
            downloadExistingReport(reportId) {
                const report = this.reports.find(r => r.id === reportId);
                if (!report) return;

                if (window.notificationManager) {
                    window.notificationManager.showToast('レポートをダウンロードしています...', 'info');
                }

                // 実際の実装では保存されたレポートデータを取得
                setTimeout(() => {
                    const content = `スマートポリス ${report.name}\n対象期間: ${report.period}\n作成日: ${report.createdAt.toLocaleDateString('ja-JP')}\n\n※このレポートは過去に生成されたものです。`;
                    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${report.name}_${report.period}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    if (window.notificationManager) {
                        window.notificationManager.showToast('ダウンロードが完了しました', 'success');
                    }
                }, 1000);
            }

            // レポート削除
            deleteReport(reportId) {
                if (!confirm('このレポートを削除しますか？')) return;

                this.reports = this.reports.filter(r => r.id !== reportId);
                this.updateReportsTable();

                if (window.notificationManager) {
                    window.notificationManager.showToast('レポートを削除しました', 'success');
                }
            }

            // 履歴に追加
            addToReportsHistory(report) {
                this.reports.unshift(report);
                
                // 最大50件まで保持
                if (this.reports.length > 50) {
                    this.reports = this.reports.slice(0, 50);
                }
                
                this.updateReportsTable();
            }

            // カスタムレポートダイアログ
            showCustomReportDialog() {
                alert('カスタムレポート機能は今後実装予定です。\n\n・期間指定レポート\n・複数条件フィルタ\n・グラフ出力オプション\n・Excel/PDF出力');
            }
        }

        function downloadInvoicePDF(invoiceId) {
            if (window.billingManager) {
                window.billingManager.downloadInvoicePDF(invoiceId);
            }
        }

        function showPaymentOptions(invoiceId) {
            if (window.billingManager) {
                window.billingManager.showPaymentOptions(invoiceId);
            }
        }
    </script>
</body>
</html>